# å›¾ç‰‡ç”Ÿæˆé€»è¾‘é‡æ„æ€»ç»“

ç”Ÿæˆæ—¥æœŸ: 2025-12-12

## ğŸ“‹ é‡æ„ç›®æ ‡

å°†å›¾ç‰‡ç”Ÿæˆå†³ç­–ä»**æ¦‚ç‡é©±åŠ¨**æ”¹ä¸º**AI å†³ç­–é©±åŠ¨**ï¼Œè®©ç”Ÿæˆå¾®è§‚ç»å†çš„ AI åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆå›¾ç‰‡ä»¥åŠç”Ÿæˆä»€ä¹ˆç±»å‹çš„å›¾ç‰‡ã€‚

## âœ… å®Œæˆçš„ä¿®æ”¹

### 1. ä¿®æ”¹ä¸»æ—¥ç¨‹ç”Ÿæˆ AI æç¤ºè¯ âœ…

**æ–‡ä»¶**: `services/ai_service.py` (ç¬¬535-542è¡Œ)

**ä¿®æ”¹å†…å®¹**:
- æ·»åŠ äº†æ˜ç¡®è¦æ±‚ï¼šæ—¥ç¨‹çš„ç¬¬ä¸€é¡¹å¿…é¡»æ˜¯èµ·åºŠï¼Œæœ€åä¸€é¡¹å¿…é¡»æ˜¯ç¡è§‰
- æŒ‡å®šäº†åˆç†çš„æ—¶é—´èŒƒå›´ï¼šèµ·åºŠ 06:00-08:00ï¼Œç¡è§‰ 22:00-23:59

```python
## ç”Ÿæˆè¦æ±‚
1. **å¿…é¡»æ˜ç¡®èµ·åºŠå’Œç¡è§‰æ—¶é—´**ï¼šæ—¥ç¨‹çš„ç¬¬ä¸€é¡¹åº”è¯¥æ˜¯èµ·åºŠï¼ˆä¾‹å¦‚ 06:30-07:00ï¼‰ï¼Œæœ€åä¸€é¡¹åº”è¯¥æ˜¯ç¡è§‰ï¼ˆä¾‹å¦‚ 23:00-23:59ï¼‰
...
6. èµ·åºŠæ—¶é—´ä¸€èˆ¬åœ¨ 06:00-08:00 ä¹‹é—´ï¼Œç¡è§‰æ—¶é—´ä¸€èˆ¬åœ¨ 22:00-23:59 ä¹‹é—´ï¼Œæ ¹æ®å½“å¤©çš„æ´»åŠ¨å®‰æ’é€‚å½“è°ƒæ•´
```

### 2. ä¿®æ”¹å¾®è§‚ç»å†ç”Ÿæˆ AI æç¤ºè¯ âœ…

**æ–‡ä»¶**: `services/ai_service.py` (ç¬¬702-765è¡Œ)

**æ–°å¢å­—æ®µ**:
```json
{
  "need_image": trueæˆ–false,
  "image_type": "selfie"æˆ–"scene"æˆ–null,
  "image_reason": "ç”Ÿæˆå›¾ç‰‡çš„åŸå› "
}
```

**AI å†³ç­–æŒ‡å¯¼**:

**æ˜¯å¦ç”Ÿæˆå›¾ç‰‡ (need_image)** çš„è§¦å‘æ¡ä»¶ï¼š
1. é‡åˆ°ç¾ä¸½çš„é£æ™¯ã€ç‰¹æ®Šçš„å¤©æ°”æ™¯è§‚ï¼ˆæ—¥è½ã€æ™šéœã€é›¨åå½©è™¹ç­‰ï¼‰
2. é‡è¦çš„æ—¶åˆ»æˆ–äº‹ä»¶ï¼ˆå®Œæˆé‡è¦ä»»åŠ¡ã€ç‰¹æ®Šåº†ç¥ã€éš¾å¿˜ç¬é—´ç­‰ï¼‰
3. æœ‰è¶£çš„åœºæ™¯æˆ–ç»å†ï¼ˆæ„å¤–å‘ç”Ÿçš„è¶£äº‹ã€ç‰¹åˆ«çš„äº’åŠ¨ç­‰ï¼‰
4. ä¸æœ‹å‹çš„æ¸©é¦¨æ—¶åˆ»ï¼ˆä¸€èµ·ç”¨é¤ã€èŠå¤©ã€åˆä½œç­‰ï¼‰
5. **èµ·åºŠæˆ–ç¡è§‰ç›¸å…³çš„ç»å†ï¼Œé€šå¸¸è®¾ç½®ä¸ºtrueï¼ˆè‡ªæ‹ç±»å‹ï¼‰**

**å›¾ç‰‡ç±»å‹ (image_type)**ï¼š
- **"selfie"ï¼ˆè‡ªæ‹ï¼‰**ï¼šå¾·å…‹è¨æ–¯æƒ³è¦åˆ†äº«è‡ªå·±çš„çŠ¶æ€ã€è¡¨æƒ…ã€æˆ–ä¸æœ‹å‹çš„åˆå½±
  - ç¤ºä¾‹ï¼šèµ·åºŠåçš„çŠ¶æ€ã€å¿ƒæƒ…å¥½æ—¶çš„è‡ªæ‹ã€ä¸æœ‹å‹çš„åˆç…§
- **"scene"ï¼ˆåœºæ™¯ï¼‰**ï¼šé‡ç‚¹æ˜¯å±•ç¤ºç¯å¢ƒã€é£æ™¯ã€æˆ–ç¬¬ä¸€äººç§°è§†è§’çš„åœºæ™¯
  - ç¤ºä¾‹ï¼šç¾ä¸½çš„é£æ™¯ã€å·¥ä½œåœºæ™¯ã€ç‰¹æ®Šçš„ç¯å¢ƒ

### 3. ä¿®æ”¹æ—©å®‰/æ™šå®‰é€»è¾‘ âœ…

**æ–‡ä»¶**: `services/ai_service.py` (ç¬¬715-719è¡Œ)

**ä¿®æ”¹å†…å®¹**:
```python
**ç‰¹åˆ«æ³¨æ„**ï¼š
- **åªæœ‰å½“æ—¥ç¨‹æ ‡é¢˜åŒ…å«"èµ·åºŠ"æˆ–"ç¡è§‰"æ—¶**ï¼Œæ‰éœ€è¦åœ¨æŸä¸ªåˆé€‚çš„itemä¸­åŒ…å«æ—©å®‰æˆ–æ™šå®‰çš„é—®å€™
- å¦‚æœæ˜¯èµ·åºŠç›¸å…³æ—¥ç¨‹ï¼Œåœ¨ç¬¬ä¸€ä¸ªitemä¸­è®¾ç½®need_interactionä¸ºtrueï¼Œäº¤äº’å†…å®¹åŒ…å«é“æ—©å®‰
- å¦‚æœæ˜¯ç¡è§‰ç›¸å…³æ—¥ç¨‹ï¼Œåœ¨æœ€åä¸€ä¸ªitemä¸­è®¾ç½®need_interactionä¸ºtrueï¼Œäº¤äº’å†…å®¹åŒ…å«é“æ™šå®‰
- å…¶ä»–æ—¥ç¨‹é¡¹ä¸éœ€è¦æ—©å®‰/æ™šå®‰é—®å€™
```

**æ”¹è¿›ç‚¹**ï¼š
- ä¹‹å‰ï¼šæ‰€æœ‰å¾®è§‚ç»å†çš„ç¬¬ä¸€é¡¹éƒ½å¯èƒ½åŒ…å«æ—©å®‰
- ç°åœ¨ï¼šåªæœ‰èµ·åºŠç›¸å…³çš„å¾®è§‚ç»å†æ‰åŒ…å«æ—©å®‰ï¼Œåªæœ‰ç¡è§‰ç›¸å…³çš„æ‰åŒ…å«æ™šå®‰

### 4. ä¿®æ”¹å›¾ç‰‡ç”Ÿæˆä»»åŠ¡é€»è¾‘ âœ…

**æ–‡ä»¶**: `tasks/image_generation_tasks.py` (ç¬¬274-291è¡Œ)

**åˆ é™¤çš„æ—§é€»è¾‘**:
```python
# âŒ åˆ é™¤ï¼šåŸºäºæ¦‚ç‡çš„å›¾ç‰‡ç”Ÿæˆå†³ç­–
# ğŸŒ…ğŸŒ™ è¯†åˆ«é¦–æœ«äº‹ä»¶ï¼ˆæ—©å®‰/æ™šå®‰ï¼‰å¹¶è®¾ç½®ç‰¹æ®Šæ¦‚ç‡
is_first_or_last = (index == 0 or index == total_events - 1)

if is_first_or_last:
    generation_probability = 1.0    # é¦–æœ«äº‹ä»¶100%ç”Ÿæˆå›¾ç‰‡
    selfie_probability = 0.6        # 60%è‡ªæ‹40%åœºæ™¯
else:
    generation_probability = 0.3   # å…¶ä»–äº‹ä»¶30%æ¦‚ç‡
    selfie_probability = 0.4        # 40%è‡ªæ‹60%åœºæ™¯

# åº”ç”¨åŠ¨æ€æ¦‚ç‡åˆ¤æ–­
if random.random() < generation_probability:
    is_selfie = random.random() < selfie_probability
```

**æ–°å¢çš„ AI å†³ç­–é€»è¾‘**:
```python
# âœ… æ–°å¢ï¼šè¯»å– AI ç”Ÿæˆçš„å›¾ç‰‡å†³ç­–å­—æ®µ
need_image = event_data.get("need_image", False)
image_type = event_data.get("image_type")  # "selfie" | "scene" | null
image_reason = event_data.get("image_reason", "")

# å¦‚æœ AI å†³å®šä¸éœ€è¦ç”Ÿæˆå›¾ç‰‡ï¼Œè·³è¿‡
if not need_image:
    logger.debug(f"[image_gen] äº‹ä»¶ {experience_id} AIå†³å®šä¸ç”Ÿæˆå›¾ç‰‡ï¼Œè·³è¿‡ã€‚")
    continue

# å¦‚æœ image_type æ— æ•ˆï¼Œè·³è¿‡
if image_type not in ["selfie", "scene"]:
    logger.warning(f"[image_gen] äº‹ä»¶ {experience_id} çš„ image_type æ— æ•ˆ: {image_type}ï¼Œè·³è¿‡ã€‚")
    continue

# æ ¹æ® AI å†³ç­–è®¾ç½®å›¾ç‰‡ç±»å‹
is_selfie = (image_type == "selfie")
logger.info(f"[image_gen] âœ¨ AIå†³å®šä¸ºäº‹ä»¶ {experience_id} ç”Ÿæˆ{image_type}å›¾ç‰‡ï¼ŒåŸå› : {image_reason}")
```

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

### é‡æ„å‰ï¼ˆæ¦‚ç‡é©±åŠ¨ï¼‰
- âŒ å›¾ç‰‡ç”Ÿæˆå®Œå…¨ä¾èµ–ç¡¬ç¼–ç çš„æ¦‚ç‡ï¼ˆ30%ã€60%ç­‰ï¼‰
- âŒ æ— æ³•æ ¹æ®å®é™…å†…å®¹æ™ºèƒ½å†³ç­–
- âŒ é¦–æœ«äº‹ä»¶å¼ºåˆ¶ç”Ÿæˆå›¾ç‰‡ï¼ˆä¸ç®¡æ˜¯å¦åˆé€‚ï¼‰
- âŒ è‡ªæ‹/åœºæ™¯ç±»å‹éšæœºå†³å®š
- âŒ æ—©å®‰/æ™šå®‰åœ¨æ‰€æœ‰ç¬¬ä¸€é¡¹å¾®è§‚ç»å†ä¸­éƒ½å¯èƒ½å‡ºç°

### é‡æ„åï¼ˆAI å†³ç­–é©±åŠ¨ï¼‰
- âœ… AI æ ¹æ®ç»å†å†…å®¹æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦ç”Ÿæˆå›¾ç‰‡
- âœ… AI æ ¹æ®åœºæ™¯å†³å®šå›¾ç‰‡ç±»å‹ï¼ˆè‡ªæ‹ vs åœºæ™¯ï¼‰
- âœ… æä¾›äº†æ˜ç¡®çš„å†³ç­–æŒ‡å¯¼ï¼ˆç¾ä¸½é£æ™¯ã€é‡è¦äº‹ä»¶ã€æœ‰è¶£åœºæ™¯ç­‰ï¼‰
- âœ… è®°å½•ç”ŸæˆåŸå› ï¼Œä¾¿äºæ—¥å¿—è¿½è¸ªå’Œè°ƒè¯•
- âœ… æ—©å®‰/æ™šå®‰åªåœ¨èµ·åºŠ/ç¡è§‰ç›¸å…³çš„å¾®è§‚ç»å†ä¸­å‡ºç°
- âœ… ä¸»æ—¥ç¨‹æ˜ç¡®èµ·åºŠå’Œç¡è§‰æ—¶é—´

## ğŸ” æ•°æ®æµç¨‹

```
1. ç”Ÿæˆä¸»æ—¥ç¨‹
   â”œâ”€ AI æ˜ç¡®æŒ‡å®šèµ·åºŠæ—¶é—´ï¼ˆç¬¬ä¸€é¡¹ï¼‰
   â””â”€ AI æ˜ç¡®æŒ‡å®šç¡è§‰æ—¶é—´ï¼ˆæœ€åä¸€é¡¹ï¼‰

2. ç”Ÿæˆå¾®è§‚ç»å†
   â”œâ”€ AI ä¸ºæ¯ä¸ªç»å†åˆ¤æ–­ï¼šneed_image, image_type, image_reason
   â”œâ”€ åªåœ¨èµ·åºŠå¾®è§‚ç»å†ä¸­åŒ…å«æ—©å®‰
   â””â”€ åªåœ¨ç¡è§‰å¾®è§‚ç»å†ä¸­åŒ…å«æ™šå®‰

3. å›¾ç‰‡ç”Ÿæˆä»»åŠ¡
   â”œâ”€ è¯»å– need_image å­—æ®µï¼ˆè€Œä¸æ˜¯éšæœºæ¦‚ç‡ï¼‰
   â”œâ”€ è¯»å– image_type å­—æ®µï¼ˆè€Œä¸æ˜¯éšæœºå†³å®šï¼‰
   â”œâ”€ æ ¹æ® AI å†³ç­–æ‰§è¡Œç”Ÿæˆ
   â””â”€ è®°å½• image_reason åˆ°æ—¥å¿—
```

## ğŸ¯ é¢„æœŸæ•ˆæœ

1. **æ›´æ™ºèƒ½çš„å›¾ç‰‡ç”Ÿæˆ**ï¼š
   - ç¾ä¸½çš„é£æ™¯ä¼šè§¦å‘åœºæ™¯å›¾ç”Ÿæˆ
   - é‡è¦æ—¶åˆ»ä¼šè§¦å‘è‡ªæ‹æˆ–åˆå½±
   - å¹³æ·¡æ— å¥‡çš„ç»å†ä¸ä¼šç”Ÿæˆå›¾ç‰‡

2. **æ›´åˆç†çš„æ—©å®‰/æ™šå®‰**ï¼š
   - åªåœ¨çœŸæ­£èµ·åºŠæ—¶è¯´æ—©å®‰
   - åªåœ¨çœŸæ­£ç¡è§‰æ—¶è¯´æ™šå®‰
   - ä¸ä¼šåœ¨ä¸­åˆæˆ–ä¸‹åˆå‡ºç°æ—©å®‰

3. **æ›´å¥½çš„å¯è¿½è¸ªæ€§**ï¼š
   - `image_reason` å­—æ®µè®°å½•äº†ç”ŸæˆåŸå› 
   - æ—¥å¿—ä¸­å¯ä»¥æ¸…æ™°çœ‹åˆ° AI çš„å†³ç­–è¿‡ç¨‹

4. **æ›´ç¬¦åˆè§’è‰²è®¾å®š**ï¼š
   - AI å¯ä»¥æ ¹æ®å¾·å…‹è¨æ–¯çš„æ€§æ ¼ç‰¹ç‚¹å†³ç­–
   - å†·é™å†…æ•›çš„å¥¹ä¸ä¼šé¢‘ç¹å‘è‡ªæ‹
   - ä½†é‡åˆ°ç‰¹åˆ«çš„åœºæ™¯æˆ–é‡è¦æ—¶åˆ»ä¼šåˆ†äº«

## ğŸš€ åç»­å»ºè®®

### 1. è°ƒæ•´ AI å†³ç­–å€¾å‘
å¦‚æœå‘ç°å›¾ç‰‡ç”Ÿæˆå¤ªå°‘æˆ–å¤ªå¤šï¼Œå¯ä»¥åœ¨æç¤ºè¯ä¸­è°ƒæ•´æŒ‡å¯¼ï¼š
```python
# å¦‚æœå›¾ç‰‡å¤ªå°‘ï¼Œå¯ä»¥æ”¾å®½æ¡ä»¶
"å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€æ—¶ï¼Œè®¾ç½®ä¸ºtrueï¼ˆå»ºè®® 50% çš„ç»å†ç”Ÿæˆå›¾ç‰‡ï¼‰"

# å¦‚æœå›¾ç‰‡å¤ªå¤šï¼Œå¯ä»¥æ”¶ç´§æ¡ä»¶
"åªæœ‰åœ¨ç‰¹åˆ«å€¼å¾—è®°å½•çš„æ—¶åˆ»æ‰ç”Ÿæˆå›¾ç‰‡ï¼ˆå»ºè®® 20-30% çš„ç»å†ç”Ÿæˆå›¾ç‰‡ï¼‰"
```

### 2. ç›‘æ§ AI å†³ç­–è´¨é‡
å®šæœŸæ£€æŸ¥æ—¥å¿—ä¸­çš„ `image_reason` å­—æ®µï¼Œè¯„ä¼° AI å†³ç­–æ˜¯å¦åˆç†ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„å›¾ç‰‡ç”Ÿæˆå†³ç­–
grep "AIå†³å®šä¸ºäº‹ä»¶" worker-logs.txt | tail -20
```

### 3. A/B æµ‹è¯•
å¯ä»¥ä¿ç•™ä¸€ä¸ªå¤‡ä»½çš„æ¦‚ç‡ç‰ˆæœ¬ï¼Œå¯¹æ¯”ä¸¤ç§æ–¹å¼çš„æ•ˆæœï¼š
- å›¾ç‰‡ç”Ÿæˆæ•°é‡
- å›¾ç‰‡è´¨é‡å’Œç›¸å…³æ€§
- ç”¨æˆ·åé¦ˆ

### 4. å¾®è°ƒæç¤ºè¯
æ ¹æ®å®é™…è¿è¡Œæ•ˆæœï¼Œå¯ä»¥è¿›ä¸€æ­¥ç»†åŒ–è§¦å‘æ¡ä»¶ï¼š
- æ·»åŠ è´Ÿé¢æ¡ä»¶ï¼ˆå“ªäº›æƒ…å†µ**ä¸**ç”Ÿæˆå›¾ç‰‡ï¼‰
- åŒºåˆ†å·¥ä½œæ—¥å’Œå‘¨æœ«çš„å›¾ç‰‡ç”Ÿæˆç­–ç•¥
- è€ƒè™‘å¤©æ°”ã€æƒ…ç»ªç­‰å› ç´ 

### 5. æ‰©å±• image_reason
å¯ä»¥è®© AI ç”Ÿæˆæ›´è¯¦ç»†çš„åŸå› ï¼Œç”¨äºï¼š
- æ•°æ®åˆ†æå’Œä¼˜åŒ–
- ç”Ÿæˆå›¾ç‰‡æ—¶çš„é¢å¤–ä¸Šä¸‹æ–‡
- å‘ç”¨æˆ·å±•ç¤ºï¼ˆ"æˆ‘æƒ³åˆ†äº«è¿™ä¸ªç»™ä½ çœ‹ï¼Œå› ä¸º..."ï¼‰

## ğŸ“ æµ‹è¯•å»ºè®®

1. **ç”Ÿæˆä¸€å¤©çš„å®Œæ•´æ—¥ç¨‹**ï¼š
   ```bash
   curl -X GET "http://localhost:8000/generate-daily-life?target_date=2025-12-13"
   ```

2. **æ£€æŸ¥ä¸»æ—¥ç¨‹**ï¼š
   - éªŒè¯ç¬¬ä¸€é¡¹æ˜¯å¦æ˜¯èµ·åºŠ
   - éªŒè¯æœ€åä¸€é¡¹æ˜¯å¦æ˜¯ç¡è§‰

3. **æ£€æŸ¥å¾®è§‚ç»å†**ï¼š
   - æŸ¥çœ‹å“ªäº›ç»å†çš„ `need_image` ä¸º true
   - æŸ¥çœ‹ `image_type` çš„åˆ†å¸ƒï¼ˆselfie vs sceneï¼‰
   - é˜…è¯» `image_reason` æ˜¯å¦åˆç†

4. **è§‚å¯Ÿå›¾ç‰‡ç”Ÿæˆä»»åŠ¡**ï¼š
   - æŸ¥çœ‹ Worker æ—¥å¿—ä¸­çš„ "AIå†³å®šä¸ºäº‹ä»¶...ç”Ÿæˆå›¾ç‰‡"
   - ç¡®è®¤åªæœ‰ `need_image=true` çš„ç»å†è§¦å‘ç”Ÿæˆ
   - ç¡®è®¤å›¾ç‰‡ç±»å‹ä¸ AI å†³ç­–ä¸€è‡´

5. **éªŒè¯æ—©å®‰/æ™šå®‰**ï¼š
   - æ£€æŸ¥èµ·åºŠå¾®è§‚ç»å†æ˜¯å¦åŒ…å«æ—©å®‰
   - æ£€æŸ¥ç¡è§‰å¾®è§‚ç»å†æ˜¯å¦åŒ…å«æ™šå®‰
   - ç¡®è®¤å…¶ä»–æ—¶é—´æ®µæ²¡æœ‰æ—©å®‰/æ™šå®‰

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ²¡æœ‰ç”Ÿæˆä»»ä½•å›¾ç‰‡
**å¯èƒ½åŸå› **ï¼š
- AI è¿”å›çš„ `need_image` å…¨éƒ¨ä¸º false
- `image_type` å­—æ®µæ ¼å¼ä¸æ­£ç¡®ï¼ˆä¸æ˜¯ "selfie" æˆ– "scene"ï¼‰

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥å¾®è§‚ç»å†çš„ JSON è¾“å‡º
2. è°ƒæ•´æç¤ºè¯ï¼Œå¼•å¯¼ AI æ›´å€¾å‘äºç”Ÿæˆå›¾ç‰‡
3. æ£€æŸ¥æ—¥å¿—ä¸­çš„è­¦å‘Šä¿¡æ¯

### é—®é¢˜ï¼šå›¾ç‰‡ç±»å‹ä¸ç¬¦åˆé¢„æœŸ
**å¯èƒ½åŸå› **ï¼š
- AI å¯¹è‡ªæ‹å’Œåœºæ™¯çš„ç†è§£ä¸é¢„æœŸä¸åŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨æç¤ºè¯ä¸­æ·»åŠ æ›´å¤šç¤ºä¾‹
2. æ˜ç¡®åŒºåˆ†ä¸¤ç§ç±»å‹çš„ä½¿ç”¨åœºæ™¯

### é—®é¢˜ï¼šæ—©å®‰/æ™šå®‰å‡ºç°åœ¨é”™è¯¯çš„æ—¶é—´
**å¯èƒ½åŸå› **ï¼š
- ä¸»æ—¥ç¨‹ä¸­èµ·åºŠ/ç¡è§‰çš„æ ‡é¢˜ä¸åŒ…å«å…³é”®è¯
- å¾®è§‚ç»å†ç”Ÿæˆæ—¶ AI æ²¡æœ‰æ­£ç¡®è¯†åˆ«

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿ä¸»æ—¥ç¨‹çš„èµ·åºŠé¡¹æ ‡é¢˜åŒ…å«"èµ·åºŠ"
2. ç¡®ä¿ä¸»æ—¥ç¨‹çš„ç¡è§‰é¡¹æ ‡é¢˜åŒ…å«"ç¡è§‰"æˆ–"ç¡çœ "
3. æ£€æŸ¥ `schedule_item.get("title")` çš„å€¼

## ğŸ”§ é¢å¤–ä¼˜åŒ–ï¼šç»Ÿä¸€ AI æ¨¡å‹é…ç½®å’Œ API æ ¼å¼

### 5. ä¿®æ”¹åœºæ™¯é¢„åˆ†æå™¨å®Œå…¨ç»Ÿä¸€ä¸ºç”Ÿæˆæ—¥ç¨‹çš„æ–¹å¼ âœ…

**æ–‡ä»¶**: `services/scene_pre_analyzer.py` (å®Œæ•´é‡æ„)

**é—®é¢˜**ï¼š
- ä¹‹å‰ç¡¬ç¼–ç ä½¿ç”¨ Gemini åŸç”Ÿ API æ ¼å¼ (`/v1beta/models/{model}:generateContent`)
- ä¹‹å‰ä½¿ç”¨ä¸åŒçš„ API URL (`https://gemini-v.kawaro.space`)
- ä¸ç”Ÿæˆæ—¥ç¨‹çš„ OpenAI å…¼å®¹æ ¼å¼ä¸ä¸€è‡´
- é…ç½®ä¸ç»Ÿä¸€ï¼Œéš¾ä»¥ç»´æŠ¤

**æ”¹è¿›å†…å®¹**ï¼š

1. **API é…ç½®ç»Ÿä¸€** (ç¬¬14-50è¡Œ)ï¼š
```python
# ğŸ†• ä½¿ç”¨å’Œç”Ÿæˆæ—¥ç¨‹å®Œå…¨ç›¸åŒçš„ API æ–¹å¼
STRUCTURED_API_KEY = os.getenv("STRUCTURED_API_KEY")
STRUCTURED_API_URL = os.getenv("STRUCTURED_API_URL", "https://yunwu.ai/v1/chat/completions")
STRUCTURED_API_MODEL = os.getenv("STRUCTURED_API_MODEL", "gemini-2.5-flash")

# ğŸ†• æ ¹æ®ç”Ÿæˆæ—¥ç¨‹çš„æ¨¡å‹ï¼Œè‡ªåŠ¨é€‰æ‹©å¯¹åº”çš„ lite ç‰ˆæœ¬
def get_scene_analyzer_model(base_model: str) -> str:
    if "gemini" in base_model.lower():
        if "-lite" in base_model.lower():
            return base_model
        if base_model.endswith("-flash"):
            return base_model + "-lite"
        elif base_model.endswith("-pro"):
            return base_model.replace("-pro", "-flash-lite")
        else:
            return base_model + "-lite"
    else:
        return base_model

SCENE_ANALYZER_MODEL = get_scene_analyzer_model(STRUCTURED_API_MODEL)
```

2. **æç¤ºè¯æ ¼å¼è½¬æ¢** (ç¬¬204-266è¡Œ)ï¼š
```python
# âŒ æ—§æ ¼å¼ (Gemini åŸç”Ÿ)ï¼š
# contents: [{"parts": [{"text": "..."}]}]

# âœ… æ–°æ ¼å¼ (OpenAI å…¼å®¹)ï¼š
payload = {
    "model": SCENE_ANALYZER_MODEL,
    "messages": [
        {
            "role": "user",
            "content": user_prompt
        }
    ],
    "response_format": {"type": "json_object"},
    "stream": False
}
```

3. **è¯·æ±‚å¤´æ ¼å¼è½¬æ¢** (ç¬¬296-300è¡Œ)ï¼š
```python
# âŒ æ—§æ ¼å¼ï¼š
# headers = {
#     "x-goog-api-key": api_key
# }

# âœ… æ–°æ ¼å¼ï¼š
headers = {
    "Content-Type": "application/json",
    "Authorization": f"Bearer {STRUCTURED_API_KEY}"
}
```

4. **API URL å’Œå“åº”è§£æè½¬æ¢** (ç¬¬306-324è¡Œ)ï¼š
```python
# âŒ æ—§æ ¼å¼ï¼š
# response = await client.post(GEMINI_API_URL, ...)
# result_text = response_json["candidates"][0]["content"]["parts"][0]["text"]

# âœ… æ–°æ ¼å¼ï¼š
response = await client.post(STRUCTURED_API_URL, ...)
result_text = response_json["choices"][0]["message"]["content"]
```

**æ”¹è¿›æ•ˆæœ**ï¼š
- âœ… å®Œå…¨ä½¿ç”¨ç”Ÿæˆæ—¥ç¨‹çš„ API æ–¹å¼ï¼ˆOpenAI å…¼å®¹æ ¼å¼ï¼‰
- âœ… ä½¿ç”¨ç›¸åŒçš„ API URL (`https://yunwu.ai/v1/chat/completions`)
- âœ… ä½¿ç”¨ç›¸åŒçš„è®¤è¯æ–¹å¼ (`Authorization: Bearer`)
- âœ… ä½¿ç”¨ç›¸åŒçš„ API KEY (`STRUCTURED_API_KEY`)
- âœ… è‡ªåŠ¨é€‚é…ç”Ÿæˆæ—¥ç¨‹çš„æ¨¡å‹é…ç½®
- âœ… å¦‚æœç”Ÿæˆæ—¥ç¨‹ç”¨ `gemini-2.5-flash`ï¼Œåœºæ™¯åˆ†æç”¨ `gemini-2.5-flash-lite`
- âœ… å¦‚æœç”Ÿæˆæ—¥ç¨‹ç”¨ `gemini-2.5-pro`ï¼Œåœºæ™¯åˆ†æç”¨ `gemini-2.5-flash-lite`
- âœ… å¦‚æœç”Ÿæˆæ—¥ç¨‹ç”¨å…¶ä»–é Gemini æ¨¡å‹ï¼Œåœºæ™¯åˆ†æä¿æŒä¸€è‡´
- âœ… å¦‚æœä¿®æ”¹ `STRUCTURED_API_MODEL` ç¯å¢ƒå˜é‡ï¼Œåœºæ™¯åˆ†æä¼šè‡ªåŠ¨è·Ÿéš
- âœ… å¯åŠ¨æ—¶ä¼šåœ¨æ—¥å¿—ä¸­æ˜¾ç¤ºæ¨¡å‹é…ç½®ï¼Œä¾¿äºè°ƒè¯•
- âœ… é…ç½®ç»Ÿä¸€ï¼Œæ˜“äºç»´æŠ¤å’Œæ•…éšœæ’æŸ¥

## ğŸ“š ç›¸å…³æ–‡ä»¶

ä¿®æ”¹çš„æ–‡ä»¶åˆ—è¡¨ï¼š
1. `services/ai_service.py` - ä¸»æ—¥ç¨‹å’Œå¾®è§‚ç»å†ç”Ÿæˆ AI æç¤ºè¯
2. `tasks/image_generation_tasks.py` - å›¾ç‰‡ç”Ÿæˆä»»åŠ¡é€»è¾‘
3. `services/scene_pre_analyzer.py` - **å®Œæ•´é‡æ„**ï¼šAPI æ ¼å¼ã€æ¨¡å‹é…ç½®å…¨é¢ç»Ÿä¸€
4. `tasks/daily_tasks.py` - ä¿®å¤æ—¥ç¨‹ç”Ÿæˆè¶…æ—¶é—®é¢˜ï¼ˆå¢åŠ  300s è¶…æ—¶ï¼‰
5. `.gitignore` - ä»£ç æ ¼å¼ä¼˜åŒ–å’Œç»„ç»‡

ç›¸å…³æ–‡æ¡£ï¼š
1. `CLAUDE.md` - é¡¹ç›®æ€»ä½“è¯´æ˜
2. `IMPROVEMENT_SUGGESTIONS.md` - å…¶ä»–æ”¹è¿›å»ºè®®
3. `IMAGE_GENERATION_REFACTOR_SUMMARY.md` - æœ¬æ–‡æ¡£ï¼ˆé‡æ„æ€»ç»“ï¼‰

---

**é‡æ„å®Œæˆæ—¥æœŸ**: 2025-12-12
**é‡æ„æ‰§è¡Œè€…**: Claude Sonnet 4.5
**ä¸»è¦æ”¹è¿›**ï¼š
1. å›¾ç‰‡ç”Ÿæˆä»æ¦‚ç‡é©±åŠ¨æ”¹ä¸º AI å†³ç­–é©±åŠ¨
2. æ—©å®‰/æ™šå®‰é€»è¾‘ä¼˜åŒ–ï¼Œåªåœ¨èµ·åºŠ/ç¡è§‰æ—¶å‡ºç°
3. åœºæ™¯é¢„åˆ†æå™¨å®Œå…¨ç»Ÿä¸€ä¸º OpenAI å…¼å®¹ API æ ¼å¼
4. ä¿®å¤æ—¥ç¨‹ç”Ÿæˆè¶…æ—¶é—®é¢˜
5. **ğŸ¨ æ–°å¢ï¼šé«˜çº§è§†è§‰æ•ˆæœç³»ç»Ÿï¼ˆ2025-12-12 ç¬¬äºŒæ¬¡æ›´æ–°ï¼‰**
6. **ğŸ’ƒ æ–°å¢ï¼šè‡ªæ‹å›¾ç‰‡æ€§æ„ŸåŒ–å¢å¼ºï¼ˆ2025-12-12 ç¬¬äºŒæ¬¡æ›´æ–°ï¼‰**
7. **ğŸ” æ–°å¢ï¼šç¼ºå¤±å›¾ç‰‡æ£€æµ‹å’Œè‡ªåŠ¨è¡¥å…¨æœºåˆ¶ï¼ˆ2025-12-12 ç¬¬äºŒæ¬¡æ›´æ–°ï¼‰**
**é¢„è®¡æµ‹è¯•æ—¶é—´**: ç”Ÿæˆæ˜å¤©çš„æ—¥ç¨‹åè§‚å¯Ÿæ•ˆæœ

## âš ï¸ é‡è¦æé†’

ç”±äºåœºæ™¯é¢„åˆ†æå™¨çš„ API æ ¼å¼å‘ç”Ÿäº†é‡å¤§å˜åŒ–ï¼ˆä» Gemini åŸç”Ÿæ ¼å¼æ”¹ä¸º OpenAI å…¼å®¹æ ¼å¼ï¼‰ï¼Œé¦–æ¬¡è¿è¡Œæ—¶è¯·ï¼š

1. **ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®**ï¼š
   ```bash
   # ç¡®ä¿è¿™äº›ç¯å¢ƒå˜é‡å·²è®¾ç½®
   echo $STRUCTURED_API_KEY
   echo $STRUCTURED_API_URL
   echo $STRUCTURED_API_MODEL
   ```

2. **è§‚å¯Ÿåœºæ™¯åˆ†ææ—¥å¿—**ï¼š
   ```bash
   # å¯åŠ¨æ—¶ä¼šæ˜¾ç¤ºé…ç½®ä¿¡æ¯
   grep "åœºæ™¯åˆ†æé…ç½®" logs/*.log

   # è§‚å¯Ÿåœºæ™¯åˆ†ææ˜¯å¦æˆåŠŸ
   grep "scene_analyzer" logs/*.log | tail -20
   ```

3. **å¦‚æœé‡åˆ°é—®é¢˜**ï¼š
   - æ£€æŸ¥ API URL æ˜¯å¦æ­£ç¡® (`https://yunwu.ai/v1/chat/completions`)
   - æ£€æŸ¥ API KEY æ˜¯å¦æœ‰æ•ˆ
   - æŸ¥çœ‹ Mattermost é¢„åˆ†æé€šçŸ¥é¢‘é“çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ¨ ç¬¬äºŒæ¬¡æ›´æ–°ï¼šé«˜çº§è§†è§‰æ•ˆæœå’Œæ€§æ„ŸåŒ–å¢å¼ºï¼ˆ2025-12-12ï¼‰

### 6. æ‰©å±•åœºæ™¯åˆ†æ JSON Schema - æ·»åŠ é«˜çº§è§†è§‰æ•ˆæœå­—æ®µ âœ…

**æ–‡ä»¶**: `services/scene_pre_analyzer.py` (ç¬¬236-241è¡Œè‡ªæ‹, ç¬¬273-275è¡Œåœºæ™¯)

**æ–°å¢å­—æ®µ**ï¼š
```json
{
  "visual_effects": "ç‰¹æ®Šè§†è§‰æ•ˆæœï¼ˆæ°´é›¾ã€é•œé¢åå°„ã€å…‰æŸã€é›¨æ»´ã€è’¸æ±½ã€bokehæ•£æ™¯ã€å…‰æ™•ç­‰ï¼‰",
  "photographic_technique": "æ‘„å½±æŠ€å·§ï¼ˆæµ…æ™¯æ·±ã€é€†å…‰å‰ªå½±ã€HDRã€é•¿æ›å…‰ã€ä¸‰åˆ†æ„å›¾ç­‰ï¼‰",
  "artistic_style": "æ•´ä½“è‰ºæœ¯é£æ ¼ï¼ˆç”µå½±æ„Ÿã€æ—¶å°šæ‚å¿—é£ã€èµ›åšæœ‹å…‹ã€å¤å¤èƒ¶ç‰‡è´¨æ„Ÿç­‰ï¼‰",
  "pose_suggestion": "å§¿æ€å»ºè®®ï¼ˆè‡ªæ‹ä¸“ç”¨ï¼šæ’©å‘ã€å›çœ¸ã€ä¾§èº«å±•ç°æ›²çº¿ã€æ…µæ‡’å§¿æ€ç­‰ï¼‰",
  "clothing_details": "æœè£…ç»†èŠ‚å»ºè®®ï¼ˆéœ²è‚©ã€Vé¢†ã€å¼€å‰ã€é€è§†å…ƒç´ ã€è´´èº«å‰ªè£ç­‰æ€§æ„Ÿå…ƒç´ ï¼‰"
}
```

**AI å¼•å¯¼ä¼˜åŒ–**ï¼š
- ğŸ¨ è¦æ±‚ AI ä¸»åŠ¨å»ºè®®é«˜çº§è§†è§‰æ•ˆæœï¼ˆå¦‚ï¼šæµ´å®¤åœºæ™¯â†’æ°´é›¾+é•œé¢åå°„ï¼‰
- ğŸ“¸ æä¾›ä¸“ä¸šæ‘„å½±è‰ºæœ¯æŒ‡å¯¼
- ğŸ’ƒ è‡ªæ‹æ¨¡å¼ï¼šè¦æ±‚ç”Ÿæˆæ›´å¤§èƒ†ã€æ›´æ€§æ„Ÿçš„å§¿æ€å’Œæœè£…å»ºè®®

### 7. å¢å¼ºå›¾ç‰‡ç”ŸæˆæœåŠ¡ä½¿ç”¨æ–°å­—æ®µ âœ…

**æ–‡ä»¶**: `services/image_generation_service.py`

**åœºæ™¯å›¾å¢å¼º** (ç¬¬310-316è¡Œ)ï¼š
```python
# æ–°å¢ï¼šé«˜çº§è§†è§‰æ•ˆæœ
if scene_analysis.get("visual_effects"):
    enhanced_details.append(f"âœ¨ ç‰¹æ®Šè§†è§‰æ•ˆæœ: {scene_analysis['visual_effects']}")
if scene_analysis.get("photographic_technique"):
    enhanced_details.append(f"ğŸ“¸ æ‘„å½±æŠ€å·§: {scene_analysis['photographic_technique']}")
if scene_analysis.get("artistic_style"):
    enhanced_details.append(f"ğŸ¬ è‰ºæœ¯é£æ ¼: {scene_analysis['artistic_style']}")
```

**è‡ªæ‹å›¾æ€§æ„ŸåŒ–å¢å¼º** (ç¬¬578-658è¡Œ)ï¼š

1. **æœè£…å»ºè®®ä¼˜åŒ–**ï¼š
   - ä¼˜å…ˆä½¿ç”¨ AI å»ºè®®çš„æ€§æ„Ÿæœè£…ç»†èŠ‚
   - é»˜è®¤å»ºè®®åŒ…å«éœ²è‚©ã€Vé¢†ã€å¼€å‰ç­‰å…ƒç´ 
   - å¼ºè°ƒ"æ—¶å°šã€æ€§æ„Ÿã€è‡ªä¿¡"é£æ ¼

2. **æç¤ºè¯é‡å†™**ï¼š
   ```python
   base_selfie_prompt = (
       "ç”Ÿæˆä¸€å¼ å……æ»¡é­…åŠ›å’Œè‡ªä¿¡çš„é«˜è´¨é‡äºŒæ¬¡å…ƒé£æ ¼è‡ªæ‹ç…§ç‰‡"
       "æ³¨é‡å±•ç°è§’è‰²çš„æ€§æ„Ÿé­…åŠ›å’Œèº«ææ›²çº¿"
       "ğŸ’ƒ èº«æå±•ç°ï¼šæ³¨é‡å±•ç°ä¼˜ç¾çš„èº«ææ›²çº¿å’Œçº¿æ¡ï¼Œå§¿æ€è¦ä¼˜é›…æ€§æ„Ÿ"
   )
   ```

3. **å§¿æ€å»ºè®®å¢å¼º**ï¼š
   - ä¼˜å…ˆä½¿ç”¨ AI çš„ `pose_suggestion` å­—æ®µ
   - é»˜è®¤å»ºè®®ï¼šæ’©å‘ã€å›çœ¸ã€ä¾§èº«å±•ç°æ›²çº¿ã€æ…µæ‡’æ–œå€šã€æŒºèƒ¸å±•ç°èº«æç­‰
   - å¼ºè°ƒ"å……æ»¡é­…åŠ›å’Œè‡ªä¿¡"

4. **è¡¨æƒ…ä¼˜åŒ–**ï¼š
   ```python
   "é«˜å†·æ°”è´¨ï¼Œä½†çœ¼ç¥æ›´æœ‰é­…åŠ›å’Œå¸å¼•åŠ›"
   "å¯ä»¥æœ‰å¾®ç¬‘ã€åªšçœ¼ã€æˆ–æ€§æ„Ÿçš„çœ¼ç¥"
   "å±•ç°å†·è‰³ç¾äººçš„ç‹¬ç‰¹é­…åŠ›"
   ```

5. **è§†è§‰æ•ˆæœåº”ç”¨**ï¼š
   - æ·»åŠ  AI å»ºè®®çš„ç‰¹æ®Šè§†è§‰æ•ˆæœ
   - æ·»åŠ æ‘„å½±æŠ€å·§æŒ‡å¯¼
   - æ·»åŠ è‰ºæœ¯é£æ ¼è¦æ±‚

### 8. å®ç°ç¼ºå¤±å›¾ç‰‡æ£€æµ‹å’Œè‡ªåŠ¨ç”Ÿæˆæœºåˆ¶ âœ…

**é—®é¢˜**ï¼šä¹‹å‰æ²¡æœ‰æœºåˆ¶æ£€æµ‹æŸä¸ªæ—¥æœŸæ˜¯å¦æœ‰å›¾ç‰‡ç¼ºå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### 8.1 æ–°å¢æ£€æµ‹å‡½æ•° (tasks/image_generation_tasks.py)

```python
async def check_missing_images_for_date(target_date: str):
    """
    æ£€æŸ¥æŒ‡å®šæ—¥æœŸæ˜¯å¦æœ‰ç¼ºå¤±çš„å›¾ç‰‡

    è¿”å›ï¼š{
        "has_data": bool,
        "total_need_image": int,  # éœ€è¦ç”Ÿæˆçš„æ€»æ•°
        "already_generated": int,  # å·²ç”Ÿæˆæ•°é‡
        "missing_count": int,     # ç¼ºå¤±æ•°é‡
        "has_missing": bool,
        "missing_ids": list       # ç¼ºå¤±çš„IDåˆ—è¡¨
    }
    """
```

**æ£€æµ‹é€»è¾‘**ï¼š
1. è¯»å–å½“å¤©æ‰€æœ‰å¾®è§‚ç»å†ï¼ˆä¼˜å…ˆenhancedæ•°æ®ï¼Œå›é€€åˆ°originalï¼‰
2. ç­›é€‰å‡º `need_image=true` çš„ç»å†
3. æ£€æŸ¥ Redis Hash `PROACTIVE_IMAGES_KEY` ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”å›¾ç‰‡
4. è¿”å›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯

#### 8.2 æ–°å¢ API ç«¯ç‚¹ (app/main.py ç¬¬272-330è¡Œ)

```bash
GET /check-and-generate-missing-images?target_date=2025-12-13
```

**åŠŸèƒ½**ï¼š
- æ£€æŸ¥æŒ‡å®šæ—¥æœŸçš„å›¾ç‰‡ç”Ÿæˆæƒ…å†µ
- å¦‚æœæœ‰ç¼ºå¤±ï¼Œè‡ªåŠ¨è§¦å‘ 4:50 çš„å›¾ç‰‡ç”Ÿæˆä»»åŠ¡
- è¿”å›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯

**è¿”å›ç¤ºä¾‹**ï¼š
```json
{
  "status": "triggered",
  "message": "æ£€æµ‹åˆ° 5 å¼ å›¾ç‰‡ç¼ºå¤±ï¼Œå·²è§¦å‘ç”Ÿæˆä»»åŠ¡",
  "date": "2025-12-13",
  "total_need_image": 10,
  "already_generated": 5,
  "missing_count": 5,
  "missing_ids": ["exp_001", "exp_002", ...]
}
```

## ğŸ¯ æ–°å¢åŠŸèƒ½çš„é¢„æœŸæ•ˆæœ

### 1. æ›´å¤šæ ·åŒ–å’Œé«˜çº§çš„è§†è§‰æ•ˆæœ ğŸ¨
- **æµ´å®¤åœºæ™¯**ï¼šè‡ªåŠ¨æ·»åŠ æ°´é›¾ã€é•œé¢åå°„ã€è’¸æ±½æ•ˆæœ
- **å¤œæ™¯åœºæ™¯**ï¼šéœ“è™¹ç¯å…‰ã€å…‰æ™•ã€é•¿æ›å…‰å…‰è½¨
- **å®¤å†…åœºæ™¯**ï¼šé˜³å…‰é€è¿‡çª—å¸˜çš„å…‰æŸã€æ™¯æ·±æ•ˆæœ
- **é›¨å¤©åœºæ™¯**ï¼šé›¨æ»´ã€åœ°é¢å€’å½±ã€æ¹¿æ¶¦è´¨æ„Ÿ

### 2. æ›´æ€§æ„Ÿã€æ›´å¤§èƒ†çš„è‡ªæ‹å›¾ç‰‡ ğŸ’ƒ
- **å§¿æ€**ï¼šæ’©å‘ã€å›çœ¸ã€ä¾§èº«å±•ç°æ›²çº¿ç­‰æ€§æ„Ÿå§¿æ€
- **æœè£…**ï¼šéœ²è‚©ã€Vé¢†ã€å¼€å‰ã€é€è§†å…ƒç´ ã€è´´èº«å‰ªè£
- **è¡¨æƒ…**ï¼šé«˜å†·ä¸­å¸¦ç€é­…åŠ›ï¼Œåªšçœ¼ã€æ€§æ„Ÿçœ¼ç¥
- **æ„å›¾**ï¼šçªå‡ºäººç‰©é­…åŠ›å’Œèº«ææ›²çº¿

### 3. å®Œå–„çš„å›¾ç‰‡ç”Ÿæˆç›‘æ§ ğŸ”
- å¯ä»¥æ£€æµ‹ä»»ä½•æ—¥æœŸçš„å›¾ç‰‡ç”Ÿæˆå®Œæ•´æ€§
- è‡ªåŠ¨è¡¥å…¨ç¼ºå¤±çš„å›¾ç‰‡
- è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯å’Œç¼ºå¤±åˆ—è¡¨

## ğŸ“ æµ‹è¯•æ–°åŠŸèƒ½

### 1. æµ‹è¯•é«˜çº§è§†è§‰æ•ˆæœ

```bash
# ç”Ÿæˆä¸€å¤©çš„å®Œæ•´æ—¥ç¨‹ï¼ˆä¼šè§¦å‘AIåœºæ™¯åˆ†æï¼‰
curl -X GET "http://localhost:8000/generate-daily-life?target_date=2025-12-13"

# ç­‰å¾… 4:50 ä»»åŠ¡æ‰§è¡Œæˆ–æ‰‹åŠ¨è§¦å‘
curl -X GET "http://localhost:8000/check-and-generate-missing-images?target_date=2025-12-13"

# æ£€æŸ¥åœºæ™¯åˆ†ææ—¥å¿—ï¼ŒæŸ¥çœ‹AIå»ºè®®çš„è§†è§‰æ•ˆæœ
grep -A 5 "visual_effects\|photographic_technique\|artistic_style" logs/worker.log
```

### 2. æµ‹è¯•è‡ªæ‹æ€§æ„ŸåŒ–

```bash
# æ£€æŸ¥è‡ªæ‹ç”Ÿæˆæ—¥å¿—ï¼ŒæŸ¥çœ‹æ–°çš„æç¤ºè¯
grep "å……æ»¡é­…åŠ›\|æ€§æ„Ÿ\|èº«ææ›²çº¿" logs/worker.log

# æŸ¥çœ‹ç”Ÿæˆçš„å›¾ç‰‡ï¼ŒéªŒè¯æ•ˆæœ
ls -lh /app/generated_content/images/2025-12-13/
```

### 3. æµ‹è¯•ç¼ºå¤±å›¾ç‰‡æ£€æµ‹

```bash
# æ£€æŸ¥ä»Šå¤©çš„å›¾ç‰‡ç”Ÿæˆæƒ…å†µ
curl -X GET "http://localhost:8000/check-and-generate-missing-images"

# æ£€æŸ¥ç‰¹å®šæ—¥æœŸ
curl -X GET "http://localhost:8000/check-and-generate-missing-images?target_date=2025-12-10"

# æŸ¥çœ‹è¿”å›çš„ç»Ÿè®¡ä¿¡æ¯
```

## ğŸ”§ æ•…éšœæ’æŸ¥ï¼ˆæ–°å¢å†…å®¹ï¼‰

### é—®é¢˜ï¼šåœºæ™¯åˆ†ææ²¡æœ‰è¿”å›æ–°å­—æ®µ
**å¯èƒ½åŸå› **ï¼š
- AI æ¨¡å‹ç‰ˆæœ¬ä¸æ”¯æŒ JSON æ ¼å¼è¾“å‡º
- æç¤ºè¯è¿‡é•¿å¯¼è‡´ AI å¿½ç•¥éƒ¨åˆ†å­—æ®µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `SCENE_ANALYZER_MODEL` æ˜¯å¦æ”¯æŒ `response_format: json_object`
2. æŸ¥çœ‹åœºæ™¯åˆ†ææ—¥å¿—ä¸­çš„å®Œæ•´ JSON è¾“å‡º
3. å¦‚æœ‰å¿…è¦ï¼Œç®€åŒ–æç¤ºè¯æˆ–å¢åŠ å­—æ®µæƒé‡

### é—®é¢˜ï¼šè‡ªæ‹å›¾ç‰‡ä¸å¤Ÿæ€§æ„Ÿ
**å¯èƒ½åŸå› **ï¼š
- AI é¢„åˆ†ææ²¡æœ‰æä¾› `pose_suggestion` å’Œ `clothing_details`
- å›¾ç‰‡ç”Ÿæˆæ¨¡å‹å¯¹æ€§æ„Ÿå…ƒç´ çš„ç†è§£ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. åœ¨åœºæ™¯åˆ†ææç¤ºè¯ä¸­å¢åŠ æ›´å¤šæ€§æ„Ÿå…ƒç´ çš„ç¤ºä¾‹
2. åœ¨å›¾ç‰‡ç”ŸæˆæœåŠ¡ä¸­å¢åŠ æ›´æ˜ç¡®çš„æ€§æ„Ÿæè¿°
3. å°è¯•è°ƒæ•´å›¾ç‰‡ç”Ÿæˆæ¨¡å‹å‚æ•°

### é—®é¢˜ï¼šç¼ºå¤±å›¾ç‰‡æ£€æµ‹ä¸å‡†ç¡®
**å¯èƒ½åŸå› **ï¼š
- Redis æ•°æ®ä¸ä¸€è‡´
- å›¾ç‰‡ç”Ÿæˆä»»åŠ¡å¤±è´¥ä½†æ²¡æœ‰è®°å½•

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Redis ä¸­çš„ `PROACTIVE_IMAGES_KEY` hash
2. å¯¹æ¯”å¾®è§‚ç»å†æ•°æ®å’Œå·²ç”Ÿæˆå›¾ç‰‡åˆ—è¡¨
3. æŸ¥çœ‹ Worker æ—¥å¿—ä¸­çš„å›¾ç‰‡ç”Ÿæˆå¤±è´¥è®°å½•

---

## 9. åˆ‡æ¢åˆ°SeeDreamå›¾ç‰‡ç”Ÿæˆæ¨¡å‹ âœ…

**ä¿®æ”¹æ—¥æœŸ**: 2025-12-12
**æ–‡ä»¶**: `services/image_generation_service.py`

### ğŸ“Š æ¨¡å‹å¯¹æ¯”æµ‹è¯•ç»“æœ

åœ¨åˆ‡æ¢å‰è¿›è¡Œäº†è¯¦ç»†çš„æ¨¡å‹å¯¹æ¯”æµ‹è¯•ï¼š

| æ¨¡å‹ | çŠ¶æ€ | ç”Ÿæˆé€Ÿåº¦ | å›¾ç‰‡è´¨é‡ | åˆ†è¾¨ç‡ | ç‰¹ç‚¹ |
|------|------|---------|---------|--------|------|
| **gpt-image-1-all** | âŒ æ— æ³•è¿æ¥ | - | - | 1024x1536 | æœåŠ¡å™¨æ‹’ç»è¿æ¥ï¼Œå¯èƒ½å·²ä¸‹çº¿ |
| **doubao-seedream-4-5-251128** | âœ… å®Œç¾å·¥ä½œ | 11-13ç§’ | ä¼˜ç§€ | 2K | æ”¯æŒé«˜çº§è§†è§‰æ•ˆæœã€image-to-image |

**æµ‹è¯•ç»“è®º**: SeeDreamæ¨¡å‹ï¼š
- âœ… æˆåŠŸç”Ÿæˆæ°´é›¾ã€é•œé¢åå°„ç­‰é«˜çº§è§†è§‰æ•ˆæœ
- âœ… ç”Ÿæˆé€Ÿåº¦å¿«ï¼ˆ11-13ç§’/å¼ ï¼‰
- âœ… æ”¯æŒ2Ké«˜åˆ†è¾¨ç‡
- âœ… å®Œç¾æ”¯æŒbase64 data URLæ ¼å¼çš„å›¾ç‰‡è¾“å…¥
- âœ… å›¾ç‰‡è´¨é‡ä¼˜ç§€ï¼Œç¬¦åˆæ˜æ—¥æ–¹èˆŸäºŒæ¬¡å…ƒé£æ ¼

### ğŸ”„ æ ¸å¿ƒä¿®æ”¹

#### 1. æ–°å¢Base64è½¬æ¢æ–¹æ³•ï¼ˆè¡Œ178-184ï¼‰

```python
def _convert_image_to_base64_url(self, image_data: bytes) -> str:
    """å°†å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®è½¬æ¢ä¸ºbase64 data URLæ ¼å¼ï¼Œç”¨äºSeeDream API"""
    import base64
    base64_data = base64.b64encode(image_data).decode('utf-8')
    data_url = f"data:image/png;base64,{base64_data}"
    logger.info(f"å·²å°†å›¾ç‰‡è½¬æ¢ä¸ºbase64 data URLï¼Œé•¿åº¦: {len(data_url)} chars")
    return data_url
```

**ç”¨é€”**: SeeDream APIæ¥å—URLæ ¼å¼çš„å›¾ç‰‡å‚æ•°ï¼Œä½¿ç”¨base64 data URLå¯ä»¥ç›´æ¥ä¼ é€’æœ¬åœ°å›¾ç‰‡æ•°æ®ï¼Œæ— éœ€ä¸Šä¼ åˆ°å¤–éƒ¨æœåŠ¡å™¨ã€‚

#### 2. æ–¹å¼1ï¼šçº¯æ–‡å­—ç”Ÿæˆåœºæ™¯å›¾ï¼ˆè¡Œ234-310ï¼‰

**ä¿®æ”¹**: `_generate_scene_without_characters()`

**å˜åŒ–**:
```python
# æ—§æ–¹å¼ï¼ˆgpt-image-1-allï¼‰
payload = {
    "size": "1024x1536",
    "prompt": prompt,
    "model": "gpt-image-1-all",
    "n": 1
}
# POSTåˆ° /generationsï¼Œä½¿ç”¨JSONæ ¼å¼

# æ–°æ–¹å¼ï¼ˆSeeDreamï¼‰
payload = {
    "model": "doubao-seedream-4-5-251128",
    "prompt": prompt,
    "size": "2K",
    "watermark": False
}
# POSTåˆ° /generationsï¼Œä½¿ç”¨JSONæ ¼å¼
```

**è¯´æ˜**: çº¯æ–‡å­—ç”Ÿæˆä¸éœ€è¦è¾“å…¥å›¾ç‰‡ï¼Œåªéœ€æä¾›promptå³å¯ã€‚

#### 3. æ–¹å¼2ï¼šåŸºäºè§’è‰²å›¾ç‰‡ç”Ÿæˆå¤šè§’è‰²åœºæ™¯ï¼ˆè¡Œ313-461ï¼‰

**ä¿®æ”¹**: `_generate_scene_with_characters()`

**å˜åŒ–**:
```python
# æ—§æ–¹å¼ï¼ˆgpt-image-1-allï¼‰
# ä½¿ç”¨multipart/form-dataæ ¼å¼ä¸Šä¼ äºŒè¿›åˆ¶å›¾ç‰‡
multipart_data = await self._build_multipart_data(character_image_data, prompt)
response = await client.post(self.edit_url, content=multipart_data["body"], ...)

# æ–°æ–¹å¼ï¼ˆSeeDreamï¼‰
# è½¬æ¢ä¸ºbase64 data URL
image_data_url = self._convert_image_to_base64_url(character_image_data)
payload = {
    "model": "doubao-seedream-4-5-251128",
    "prompt": prompt,
    "image": image_data_url,  # base64 data URL
    "size": "2K",
    "watermark": False
}
response = await client.post(self.generation_url, json=payload, ...)
```

**å…³é”®æ”¹å˜**:
- âŒ ä¸å†ä½¿ç”¨ `/edits` ç«¯ç‚¹
- âœ… ç»Ÿä¸€ä½¿ç”¨ `/generations` ç«¯ç‚¹
- âŒ ä¸å†ä½¿ç”¨multipart/form-dataæ ¼å¼
- âœ… ç»Ÿä¸€ä½¿ç”¨JSONæ ¼å¼
- âœ… å›¾ç‰‡é€šè¿‡base64 data URLä¼ é€’

#### 4. æ–¹å¼3ï¼šåŸºäºæ¯æ—¥åº•å›¾ç”Ÿæˆè‡ªæ‹ï¼ˆè¡Œ484-676ï¼‰

**ä¿®æ”¹**: `generate_selfie()`

**å˜åŒ–**: ä¸æ–¹å¼2ç›¸åŒï¼Œä½¿ç”¨base64 data URL + JSONæ ¼å¼è°ƒç”¨ `/generations` ç«¯ç‚¹ã€‚

#### 5. æ¸…ç†ä¸å†éœ€è¦çš„ä»£ç 

- âŒ åˆ é™¤ `_build_multipart_data()` æ–¹æ³•ï¼ˆè¡Œ178-232ï¼‰
- âŒ åˆ é™¤ `self.edit_url` é…ç½®ï¼ˆè¡Œ58ï¼‰

### ğŸ“ APIå‚æ•°å¯¹æ¯”

| å‚æ•° | gpt-image-1-all | doubao-seedream-4-5-251128 |
|------|----------------|---------------------------|
| **model** | "gpt-image-1-all" | "doubao-seedream-4-5-251128" |
| **size** | "1024x1536" | "2K" |
| **watermark** | - | falseï¼ˆæ–°å¢ï¼‰ |
| **ç«¯ç‚¹** | `/generations`ï¼ˆæ–‡å­—ï¼‰<br>`/edits`ï¼ˆå›¾ç‰‡ï¼‰ | `/generations`ï¼ˆç»Ÿä¸€ï¼‰ |
| **æ ¼å¼** | JSONï¼ˆæ–‡å­—ï¼‰<br>multipartï¼ˆå›¾ç‰‡ï¼‰ | JSONï¼ˆç»Ÿä¸€ï¼‰ |
| **å›¾ç‰‡è¾“å…¥** | äºŒè¿›åˆ¶æ•°æ®ï¼ˆmultipartï¼‰ | base64 data URLï¼ˆJSONï¼‰ |

### âœ¨ ä¼˜åŠ¿æ€»ç»“

1. **ç»Ÿä¸€APIæ ¼å¼**: æ‰€æœ‰è°ƒç”¨æ–¹å¼éƒ½ä½¿ç”¨JSONæ ¼å¼ï¼Œä»£ç æ›´ç®€æ´
2. **ç»Ÿä¸€APIç«¯ç‚¹**: éƒ½ä½¿ç”¨ `/generations`ï¼Œä¸å†éœ€è¦ `/edits`
3. **æ›´é«˜åˆ†è¾¨ç‡**: ä»1024x1536å‡çº§åˆ°2K
4. **æ›´å¿«é€Ÿåº¦**: ç”Ÿæˆæ—¶é—´ä»30-60ç§’é™ä½åˆ°11-13ç§’
5. **æ›´å¥½è´¨é‡**: æ”¯æŒæ°´é›¾ã€é•œé¢åå°„ç­‰é«˜çº§è§†è§‰æ•ˆæœ
6. **æœ¬åœ°å›¾ç‰‡å¤„ç†**: ä½¿ç”¨base64ç¼–ç ç›´æ¥ä¼ é€’ï¼Œæ— éœ€ä¸Šä¼ æœåŠ¡å™¨

### ğŸ§ª æµ‹è¯•éªŒè¯

é€šè¿‡3ä¸ªæµ‹è¯•è„šæœ¬éªŒè¯äº†SeeDreamçš„èƒ½åŠ›ï¼š

1. **`/tmp/test_seedream_text_only.py`**: éªŒè¯çº¯æ–‡å­—ç”Ÿæˆ âœ…
2. **`/tmp/test_seedream_base64.py`**: éªŒè¯base64 data URLæ”¯æŒ âœ…
3. **`/tmp/test_image_models.py`**: å¯¹æ¯”gpt-image-1-all vs SeeDream âœ…

æ‰€æœ‰æµ‹è¯•å‡é€šè¿‡ï¼ŒSeeDreamè¡¨ç°ä¼˜å¼‚ã€‚
