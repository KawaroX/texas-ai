<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas AI Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            border: '#334155'
                        },
                        texas: {
                            primary: '#e11d48', // Rose 600
                            accent: '#f59e0b', // Amber 500
                            bg: '#0f172a'
                        }
                    },
                    fontFamily: {
                        mono: ['JetBrains Mono', 'Menlo', 'Monaco', 'Courier New', 'monospace'],
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Immersive Background */
        body {
            background-color: #020617; /* Very dark slate */
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Texas Background Image */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://media.prts.wiki/6/65/%E7%AB%8B%E7%BB%98_%E7%BC%84%E9%BB%98%E5%BE%B7%E5%85%8B%E8%90%A8%E6%96%AF_1.png?image_process=format,webp/quality,Q_90');
            background-size: cover;
            background-position: center 20%;
            background-repeat: no-repeat;
            opacity: 0.15; /* Subtle background */
            z-index: -2;
            filter: grayscale(40%) contrast(1.2);
        }
        
        /* Noise Overlay for Texture */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.4;
            pointer-events: none;
            z-index: -1;
        }

        /* Deep Glassmorphism */
        .glass-panel {
            background: rgba(15, 23, 42, 0.65); /* Darker, more opaque */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass-card:hover {
            background: rgba(30, 41, 59, 0.7);
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
        }

        /* Custom Scrollbar - Slim & Sleek */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(148, 163, 184, 0.5); }

        /* Range Slider - Tactical Style */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            height: 24px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 2px; /* Square/Diamond look */
            background: #e2e8f0;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.8);
            transform: rotate(45deg); /* Diamond shape */
            transition: all 0.2s;
        }
        input[type=range]:hover::-webkit-slider-thumb { transform: rotate(45deg) scale(1.1); background: #fff; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        /* Loading Animation */
        .loading-ring {
            display: inline-block;
            width: 20px;
            height: 20px;
        }
        .loading-ring:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 2px solid #fff;
            border-color: #fff transparent #fff transparent;
            animation: ring 1.2s linear infinite;
        }
        @keyframes ring { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased selection:bg-rose-500/30 selection:text-rose-200">

    <!-- Top Navigation - Minimalist -->
    <nav class="fixed top-0 left-0 right-0 z-50 border-b border-white/5 bg-slate-950/80 backdrop-blur-xl h-16 transition-all duration-300">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-8 h-8 flex items-center justify-center bg-rose-600/20 text-rose-500 font-bold font-mono rounded border border-rose-500/30">
                    TX
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-bold text-slate-100 tracking-wider">OMERTOSA</span>
                    <span class="text-[10px] text-slate-500 font-mono tracking-widest uppercase">System Interface v2.0</span>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- Status Indicator -->
                <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-slate-900/50 border border-slate-700/50">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    <span class="text-[10px] font-mono text-slate-400 uppercase hidden sm:inline">System Online</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Layout -->
    <div class="pt-24 pb-12 px-4 max-w-7xl mx-auto min-h-screen flex flex-col">
        
        <!-- Header Section: Integrated with Background -->
        <header class="mb-10 flex flex-col md:flex-row items-end md:items-end justify-between gap-6 animate-[fadeIn_0.5s_ease-out]">
            <div class="flex items-end gap-6">
                 <!-- No card box anymore, just floating text -->
                 <div class="relative w-24 h-24 hidden md:block">
                     <div class="absolute inset-0 bg-rose-500/20 blur-xl rounded-full"></div>
                     <img src="https://media.prts.wiki/6/65/%E7%AB%8B%E7%BB%98_%E7%BC%84%E9%BB%98%E5%BE%B7%E5%85%8B%E8%90%A8%E6%96%AF_1.png?image_process=format,webp/quality,Q_90" 
                          class="relative w-full h-full object-cover object-top rounded-lg border border-slate-600/50 shadow-2xl"
                          alt="Avatar">
                 </div>
                 <div>
                     <h1 class="text-4xl md:text-5xl font-bold text-white tracking-tight mb-2 flex items-center gap-3">
                         TEXAS
                         <span class="text-lg font-normal text-rose-500 font-mono border border-rose-500/30 px-2 py-0.5 rounded text-sm tracking-widest">OMERTOSA</span>
                     </h1>
                     <p class="text-slate-400 font-mono text-sm max-w-lg">
                        <span class="text-slate-500">CLASS:</span> EXECUTOR &nbsp;/&nbsp; 
                        <span class="text-slate-500">CODE:</span> PENGUIN LOGISTICS &nbsp;/&nbsp; 
                        <span class="text-yellow-500">â˜…â˜…â˜…â˜…â˜…â˜…</span>
                     </p>
                 </div>
            </div>
            
            <!-- Navigation Tabs -->
            <div class="flex p-1 bg-slate-900/80 backdrop-blur border border-white/5 rounded-lg w-full md:w-auto">
                <button onclick="switchTab('status')" id="tab-status" class="flex-1 md:flex-none px-6 py-2 text-sm font-medium rounded-md transition-all text-white bg-slate-800 shadow-lg border border-white/10">
                    MONITOR
                </button>
                <button onclick="switchTab('gallery')" id="tab-gallery" class="flex-1 md:flex-none px-6 py-2 text-sm font-medium rounded-md transition-all text-slate-400 hover:text-white hover:bg-white/5">
                    ARCHIVE
                </button>
                <button onclick="switchTab('stats')" id="tab-stats" class="flex-1 md:flex-none px-6 py-2 text-sm font-medium rounded-md transition-all text-slate-400 hover:text-white hover:bg-white/5">
                    ANALYSIS
                </button>
            </div>
        </header>

        <!-- Content Area: Status -->
        <div id="content-status" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                
                <!-- Left Column: Live Monitor (Tactical Display) -->
                <div class="lg:col-span-7 space-y-6">
                    <!-- Monitor Header -->
                    <div class="glass-panel p-5 rounded-lg flex items-center justify-between border-l-4 border-emerald-500">
                        <div class="flex items-center gap-3">
                            <span class="relative flex h-3 w-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 hidden" id="live-indicator"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                            </span>
                            <h2 class="text-sm font-bold text-white tracking-widest uppercase">Biometric Monitor</h2>
                        </div>
                        <div class="flex items-center gap-4">
                            <label class="flex items-center cursor-pointer gap-2 group">
                                <span class="text-[10px] text-slate-500 font-mono uppercase group-hover:text-emerald-400 transition">Auto-Sync</span>
                                <input type="checkbox" id="auto-refresh-toggle" class="peer sr-only" onchange="toggleAutoRefresh()">
                                <div class="w-8 h-4 bg-slate-800 rounded-full peer peer-checked:bg-emerald-900 peer-checked:border peer-checked:border-emerald-500/50 relative transition-colors">
                                    <div class="absolute left-0.5 top-0.5 w-3 h-3 bg-slate-500 rounded-full peer-checked:translate-x-4 peer-checked:bg-emerald-400 transition-all"></div>
                                </div>
                            </label>
                            <button onclick="loadCurrentState()" class="text-slate-500 hover:text-white transition">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Main Stats Bars (Cyberpunk Style) -->
                    <div class="glass-panel p-6 rounded-lg space-y-8 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-2 opacity-10">
                            <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                        </div>

                        <!-- Stamina -->
                        <div class="relative">
                            <div class="flex justify-between mb-1 items-end">
                                <span class="text-xs font-mono text-emerald-500 uppercase tracking-widest">Stamina</span>
                                <span class="text-xl font-mono font-bold text-white" id="display-stamina">--</span>
                            </div>
                            <div class="w-full bg-slate-800 h-2 rounded-sm overflow-hidden">
                                <div id="bar-stamina" class="h-full bg-gradient-to-r from-emerald-600 to-teal-400 transition-all duration-700 w-0"></div>
                            </div>
                            <div class="flex justify-between mt-1">
                                <span class="text-[10px] text-slate-600 font-mono">CRITICAL</span>
                                <span class="text-[10px] text-slate-600 font-mono">OPTIMAL</span>
                            </div>
                        </div>
                        
                        <!-- Lust -->
                        <div class="relative">
                            <div class="flex justify-between mb-1 items-end">
                                <span class="text-xs font-mono text-rose-500 uppercase tracking-widest">Arousal Level</span>
                                <span class="text-xl font-mono font-bold text-white" id="display-lust">--</span>
                            </div>
                            <div class="w-full bg-slate-800 h-2 rounded-sm overflow-hidden">
                                <div id="bar-lust" class="h-full bg-gradient-to-r from-rose-600 to-pink-500 transition-all duration-700 w-0"></div>
                            </div>
                            <div class="w-full flex gap-0.5 mt-1">
                                <div class="h-1 w-1 bg-rose-900/50 flex-1"></div>
                                <div class="h-1 w-1 bg-rose-900/50 flex-1"></div>
                                <div class="h-1 w-1 bg-rose-900/50 flex-1"></div>
                                <div class="h-1 w-1 bg-rose-900/50 flex-1"></div>
                            </div>
                        </div>

                        <!-- Sensitivity -->
                        <div class="relative">
                            <div class="flex justify-between mb-1 items-end">
                                <span class="text-xs font-mono text-violet-500 uppercase tracking-widest">Sensitivity</span>
                                <span class="text-xl font-mono font-bold text-white" id="display-sensitivity">--</span>
                            </div>
                            <div class="w-full bg-slate-800 h-2 rounded-sm overflow-hidden">
                                <div id="bar-sensitivity" class="h-full bg-gradient-to-r from-violet-600 to-purple-500 transition-all duration-700 w-0"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Info Cards Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Mood PAD Model -->
                        <div class="glass-panel p-6 rounded-lg">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">PAD Emotional Matrix</h3>
                            <div class="space-y-6">
                                <div class="relative">
                                    <div class="flex justify-between text-[10px] font-mono text-slate-500 mb-1 uppercase">
                                        <span>Pleasure</span>
                                        <span id="display-pleasure" class="text-white">0.0</span>
                                    </div>
                                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden flex">
                                        <div class="w-1/2 h-full bg-transparent border-r border-slate-600"></div> <!-- Center marker -->
                                        <div id="bar-pleasure" class="absolute h-1.5 bg-emerald-500 transition-all duration-500" style="left: 50%; width: 0%"></div>
                                    </div>
                                </div>
                                <div class="relative">
                                    <div class="flex justify-between text-[10px] font-mono text-slate-500 mb-1 uppercase">
                                        <span>Arousal</span>
                                        <span id="display-arousal" class="text-white">0.0</span>
                                    </div>
                                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden flex">
                                         <div class="w-1/2 h-full bg-transparent border-r border-slate-600"></div>
                                        <div id="bar-arousal" class="absolute h-1.5 bg-orange-500 transition-all duration-500" style="left: 50%; width: 0%"></div>
                                    </div>
                                </div>
                                <div class="relative">
                                    <div class="flex justify-between text-[10px] font-mono text-slate-500 mb-1 uppercase">
                                        <span>Dominance</span>
                                        <span id="display-dominance" class="text-white">0.0</span>
                                    </div>
                                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden flex">
                                         <div class="w-1/2 h-full bg-transparent border-r border-slate-600"></div>
                                        <div id="bar-dominance" class="absolute h-1.5 bg-purple-500 transition-all duration-500" style="left: 50%; width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 pt-4 border-t border-white/5 flex items-center gap-3">
                                    <div class="w-10 h-10 rounded bg-slate-800 flex items-center justify-center text-xl">ðŸ’­</div>
                                    <div>
                                        <div id="mood-flavor" class="text-sm font-bold text-white font-mono">--</div>
                                        <div id="mood-desc" class="text-[10px] text-slate-500 uppercase tracking-wider">--</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bio Info -->
                        <div class="glass-panel p-6 rounded-lg flex flex-col justify-between">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 border-b border-white/5 pb-2">Physiological Data</h3>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-500 font-mono">CYCLE PHASE</span>
                                    <div class="text-right">
                                        <div id="display-cycle-day" class="text-white font-bold text-sm">DAY --</div>
                                        <div id="display-cycle-phase" class="text-[10px] text-blue-400 uppercase">--</div>
                                    </div>
                                </div>

                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-slate-500 font-mono">SENS. LEVEL</span>
                                    <div class="text-right">
                                        <div id="display-sens-level" class="text-white font-bold text-sm">LV.--</div>
                                        <div id="display-sens-title" class="text-[10px] text-purple-400 uppercase">--</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mt-4 p-3 bg-slate-950/50 rounded border border-white/5">
                                <div class="text-[10px] text-slate-600 uppercase mb-1 font-mono">Current Desire</div>
                                <div id="display-lust-desc" class="text-xs text-slate-300 italic leading-relaxed">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Prompt Injection (Collapsible) -->
                    <div id="prompt-container" class="glass-panel p-0 rounded-lg hidden overflow-hidden">
                        <details class="group">
                            <summary class="flex items-center justify-between cursor-pointer p-4 bg-slate-800/50 hover:bg-slate-800 transition">
                                <span class="text-[10px] font-bold uppercase tracking-widest text-slate-400 flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 bg-yellow-500 rounded-full"></span>
                                    System Override Prompt
                                </span>
                                <span class="text-slate-500 group-open:rotate-180 transition">â–¼</span>
                            </summary>
                            <div class="p-4 bg-black/30 border-t border-white/5 max-h-60 overflow-y-auto custom-scrollbar">
                                <pre id="prompt-text" class="text-[10px] text-green-400/80 font-mono whitespace-pre-wrap break-all leading-relaxed"></pre>
                            </div>
                        </details>
                    </div>
                </div>

                <!-- Right Column: Controls -->
                <div class="lg:col-span-5 space-y-6">
                    <div class="glass-panel p-6 rounded-lg border-t-2 border-rose-500">
                        <div class="flex items-center justify-between mb-8">
                            <h2 class="text-sm font-bold text-white uppercase tracking-widest">State Intervention</h2>
                            <button onclick="fillCurrentValues()" class="text-[10px] px-3 py-1 bg-slate-800 hover:bg-slate-700 rounded-sm text-slate-300 border border-slate-600 transition font-mono">
                                SYNC CURRENT
                            </button>
                        </div>

                        <form id="updateForm" class="space-y-8">
                            <!-- Sliders Group -->
                            <div class="space-y-6">
                                <!-- Stamina Slider -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest font-mono">Stamina</label>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" id="stamina" min="0" max="100" step="0.1" class="flex-1"
                                               oninput="document.getElementById('num-stamina').value = this.value">
                                        <input type="number" id="num-stamina" min="0" max="100" step="0.1" 
                                               class="w-16 bg-slate-900 border border-slate-700 rounded-sm p-1 text-white text-xs font-mono text-center focus:border-emerald-500 focus:outline-none"
                                               oninput="document.getElementById('stamina').value = this.value">
                                    </div>
                                </div>

                                <!-- Lust Slider -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest font-mono">Lust</label>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" id="lust" min="0" max="100" step="0.1" class="flex-1"
                                               oninput="document.getElementById('num-lust').value = this.value">
                                        <input type="number" id="num-lust" min="0" max="100" step="0.1" 
                                               class="w-16 bg-slate-900 border border-slate-700 rounded-sm p-1 text-white text-xs font-mono text-center focus:border-rose-500 focus:outline-none"
                                               oninput="document.getElementById('lust').value = this.value">
                                    </div>
                                </div>

                                <!-- Sensitivity Slider -->
                                <div>
                                    <div class="flex justify-between mb-2">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest font-mono">Sensitivity</label>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <input type="range" id="sensitivity" min="0" max="100" step="0.1" class="flex-1"
                                               oninput="document.getElementById('num-sensitivity').value = this.value">
                                        <input type="number" id="num-sensitivity" min="0" max="100" step="0.1" 
                                               class="w-16 bg-slate-900 border border-slate-700 rounded-sm p-1 text-white text-xs font-mono text-center focus:border-violet-500 focus:outline-none"
                                               oninput="document.getElementById('sensitivity').value = this.value">
                                    </div>
                                </div>

                                <!-- Cycle & Sleep -->
                                <div class="grid grid-cols-2 gap-4 pt-2">
                                    <div class="space-y-2">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest font-mono">Cycle Day</label>
                                        <input type="number" id="cycle_day" min="1" max="28" 
                                               class="w-full bg-slate-900 border border-slate-700 rounded-sm p-2 text-white text-xs font-mono focus:border-rose-500 focus:outline-none transition text-center">
                                    </div>
                                    <div class="space-y-2">
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest font-mono">Sleep State</label>
                                        <select id="sleep_state" class="w-full bg-slate-900 border border-slate-700 rounded-sm p-2 text-white text-xs font-mono focus:border-rose-500 focus:outline-none transition">
                                            <option value="Awake">AWAKE</option>
                                            <option value="DeepSleep">DEEP SLEEP</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Mood Sliders (Collapsed Visual) -->
                                <div class="pt-6 border-t border-white/5 space-y-4">
                                    <div class="text-[10px] font-bold text-slate-600 uppercase tracking-widest font-mono mb-2">Mood Override (PAD)</div>
                                    
                                    <div class="grid grid-cols-3 gap-2">
                                        <div>
                                            <label class="block text-[9px] text-center text-slate-500 mb-1">Pleasure</label>
                                            <input type="number" id="pleasure" min="-10" max="10" step="0.1" 
                                                   class="w-full bg-slate-900 border border-slate-700 rounded-sm p-1 text-white text-xs font-mono text-center focus:border-emerald-500 focus:outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-[9px] text-center text-slate-500 mb-1">Arousal</label>
                                            <input type="number" id="arousal" min="-10" max="10" step="0.1" 
                                                   class="w-full bg-slate-900 border border-slate-700 rounded-sm p-1 text-white text-xs font-mono text-center focus:border-orange-500 focus:outline-none">
                                        </div>
                                        <div>
                                            <label class="block text-[9px] text-center text-slate-500 mb-1">Dominance</label>
                                            <input type="number" id="dominance" min="-10" max="10" step="0.1" 
                                                   class="w-full bg-slate-900 border border-slate-700 rounded-sm p-1 text-white text-xs font-mono text-center focus:border-purple-500 focus:outline-none">
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" id="btn-save" onclick="updateState()" class="w-full py-3 bg-rose-600 hover:bg-rose-500 text-white font-bold rounded-sm shadow-lg shadow-rose-900/20 border border-rose-500 transition-all font-mono tracking-widest text-sm">
                                EXECUTE CHANGES
                            </button>
                        </form>
                    </div>

                    <!-- Quick Actions Grid -->
                    <div class="glass-panel p-6 rounded-lg">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-4 font-mono">Quick Protocols</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="quickAction('reset')" class="p-3 bg-slate-800/50 hover:bg-emerald-900/30 border border-slate-700 hover:border-emerald-500/50 rounded-sm text-slate-400 hover:text-emerald-400 transition text-left group relative overflow-hidden">
                                <div class="relative z-10">
                                    <div class="text-[10px] font-bold uppercase tracking-widest mb-1 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                        RESET
                                    </div>
                                    <div class="text-[9px] text-slate-600 group-hover:text-emerald-500/70 font-mono">STA 100 / LUST 0</div>
                                </div>
                            </button>
                            <button onclick="quickAction('horny')" class="p-3 bg-slate-800/50 hover:bg-pink-900/30 border border-slate-700 hover:border-pink-500/50 rounded-sm text-slate-400 hover:text-pink-400 transition text-left group relative overflow-hidden">
                                <div class="relative z-10">
                                    <div class="text-[10px] font-bold uppercase tracking-widest mb-1 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-pink-500 animate-pulse"></span>
                                        AROUSAL
                                    </div>
                                    <div class="text-[9px] text-slate-600 group-hover:text-pink-500/70 font-mono">LUST 90 / SENS 60</div>
                                </div>
                            </button>
                            <button onclick="quickAction('menstrual')" class="p-3 bg-slate-800/50 hover:bg-red-900/30 border border-slate-700 hover:border-red-500/50 rounded-sm text-slate-400 hover:text-red-400 transition text-left group relative overflow-hidden">
                                <div class="relative z-10">
                                    <div class="text-[10px] font-bold uppercase tracking-widest mb-1 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-red-500"></span>
                                        CYCLE
                                    </div>
                                    <div class="text-[9px] text-slate-600 group-hover:text-red-500/70 font-mono">DAY 2 / STA 40</div>
                                </div>
                            </button>
                            <button onclick="quickAction('tired')" class="p-3 bg-slate-800/50 hover:bg-blue-900/30 border border-slate-700 hover:border-blue-500/50 rounded-sm text-slate-400 hover:text-blue-400 transition text-left group relative overflow-hidden">
                                <div class="relative z-10">
                                    <div class="text-[10px] font-bold uppercase tracking-widest mb-1 flex items-center gap-2">
                                        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
                                        REST
                                    </div>
                                    <div class="text-[9px] text-slate-600 group-hover:text-blue-500/70 font-mono">STA 15 / SLEEPY</div>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Area: Gallery -->
        <div id="content-gallery" class="tab-content hidden">
            <div class="glass-panel p-6 rounded-2xl min-h-[500px] flex flex-col">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <span>ðŸ“¸ CG ARCHIVE</span>
                        <span class="text-[10px] font-mono text-slate-400 px-2 py-1 bg-slate-800 rounded-sm uppercase tracking-widest" id="gallery-count">0 RECORDS</span>
                    </h2>
                    <button onclick="loadGallery(0)" class="px-4 py-2 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 border border-blue-600/50 rounded-sm transition flex items-center gap-2 font-mono text-xs tracking-wider">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        REFRESH
                    </button>
                </div>
                
                <!-- Gallery Grid -->
                <div id="galleryList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 flex-1">
                    <!-- Gallery Items will be injected here -->
                </div>

                <!-- Pagination -->
                <div id="galleryPagination" class="mt-8 flex justify-center gap-2 pt-4 border-t border-white/5">
                    <!-- Pagination buttons injected via JS -->
                </div>
            </div>
        </div>

        <!-- Content Area: Stats -->
        <div id="content-stats" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Summary Card -->
                <div class="glass-panel p-6 rounded-lg lg:col-span-1 border-l-4 border-rose-500">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Interaction Metrics</h3>
                    <div id="statsContent" class="space-y-4">
                        <!-- Stats Summary Injected JS -->
                    </div>
                </div>

                <!-- Chart Card 1 -->
                <div class="glass-panel p-6 rounded-lg lg:col-span-1">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Touchpoint Distribution</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="bodyPartChart"></canvas>
                    </div>
                </div>

                <!-- Chart Card 2 (New) -->
                <div class="glass-panel p-6 rounded-lg lg:col-span-1">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6">Action Type Distribution</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="actTypeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Template -->
    <div id="galleryModal" class="hidden fixed inset-0 z-[100] flex items-end md:items-center justify-center">
        <div class="absolute inset-0 bg-slate-950/90 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="relative w-full max-w-4xl h-[85vh] md:h-auto md:max-h-[85vh] glass-panel border-t border-white/10 md:border md:rounded-2xl p-0 flex flex-col animate-[slideUp_0.3s_ease-out]">
            <!-- Modal Header -->
            <div class="p-4 md:p-6 border-b border-white/5 flex items-center justify-between">
                <h3 class="text-lg font-bold text-white flex items-center gap-2">
                    <span class="w-1 h-6 bg-rose-500 rounded-full"></span>
                    RECORD DETAILS
                </h3>
                <button onclick="closeModal()" class="p-2 hover:bg-white/10 rounded-full transition text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Modal Content (Scrollable) -->
            <div id="modalContent" class="flex-1 overflow-y-auto p-4 md:p-6 custom-scrollbar">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentState = null;
        let currentPage = 0;
        const pageSize = 12;
        let autoRefreshInterval = null;
        let isUserInteracting = false;

        function getApiKey() {
            if (!window.INJECTED_API_KEY) {
                return window.INJECTED_API_KEY || '';
            }
            return window.INJECTED_API_KEY;
        }

        function initInteractions() {
            const inputs = document.querySelectorAll('input[type=range], input[type=number], select');
            inputs.forEach(input => {
                input.addEventListener('mousedown', () => isUserInteracting = true);
                input.addEventListener('touchstart', () => isUserInteracting = true);
                input.addEventListener('change', () => isUserInteracting = false);
                input.addEventListener('mouseup', () => setTimeout(() => isUserInteracting = false, 1000));
                input.addEventListener('touchend', () => setTimeout(() => isUserInteracting = false, 1000));
            });
        }

        function switchTab(tab) {
            ['status', 'gallery', 'stats'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const content = document.getElementById(`content-${t}`);
                
                if (t === tab) {
                    btn.classList.remove('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                    btn.classList.add('text-white', 'bg-slate-800', 'shadow-lg', 'border', 'border-white/10');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.add('text-slate-400', 'hover:text-white', 'hover:bg-white/5');
                    btn.classList.remove('text-white', 'bg-slate-800', 'shadow-lg', 'border', 'border-white/10');
                    content.classList.add('hidden');
                }
            });

            if (tab === 'gallery') loadGallery();
            if (tab === 'stats') loadStats();
            if (tab === 'status') loadCurrentState();
        }

        function toggleAutoRefresh() {
            const checkbox = document.getElementById('auto-refresh-toggle');
            const indicator = document.getElementById('live-indicator');
            
            if (checkbox.checked) {
                loadCurrentState();
                autoRefreshInterval = setInterval(loadCurrentState, 3000);
                if(indicator) indicator.classList.remove('hidden');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                if(indicator) indicator.classList.add('hidden');
            }
        }

        async function loadCurrentState() {
            try {
                const k = getApiKey();
                const response = await fetch(`${API_BASE}/debug/texas-state?k=${k}`);
                if (!response.ok) throw new Error('Failed to load state');

                const data = await response.json();
                currentState = data;
                updateStatusUI(data);
                
                if (!isUserInteracting) {
                    syncSlidersWithState(data);
                }
                
            } catch (error) {
                console.error('Error loading state:', error);
            }
        }

        function syncSlidersWithState(data) {
            const bio = data.bio;
            const mood = data.mood;

            setSlider('stamina', bio.stamina);
            setSlider('lust', bio.lust);
            setSlider('sensitivity', bio.sensitivity);
            
            const cycleInput = document.getElementById('cycle_day');
            if(cycleInput) cycleInput.value = bio.cycle_day;
            
            const sleepInput = document.getElementById('sleep_state');
            if(sleepInput) sleepInput.value = bio.sleep_state;

            setSlider('pleasure', mood.pleasure);
            setSlider('arousal', mood.arousal);
            setSlider('dominance', mood.dominance);
        }

        function updateStatusUI(data) {
            const bio = data.bio;
            const mood = data.mood;

            updateMetric('stamina', bio.stamina, 100, '', '');
            updateMetric('lust', bio.lust, 100, '', '');
            updateMetric('sensitivity', bio.sensitivity, 100, '', '');

            updatePAD('pleasure', mood.pleasure);
            updatePAD('arousal', mood.arousal);
            updatePAD('dominance', mood.dominance);

            document.getElementById('display-cycle-day').innerText = `Day ${bio.cycle_day}`;
            document.getElementById('display-cycle-phase').innerText = data.detailed_info.cycle.phase;
            
            document.getElementById('display-sens-level').innerText = `Lv.${data.detailed_info.sensitivity.level}`;
            document.getElementById('display-sens-title').innerText = data.detailed_info.sensitivity.title;
            
            document.getElementById('display-lust-desc').innerText = data.detailed_info.lust_description.substring(0, 100) + '...';
            
            // Restore Sexual Release Info
            const sexualInfo = data.detailed_info.sexual;
            if (sexualInfo) {
                const releaseDiv = document.getElementById('display-lust-desc').parentElement;
                let releaseTimeElem = document.getElementById('display-release-time');
                
                if (!releaseTimeElem) {
                    releaseTimeElem = document.createElement('div');
                    releaseTimeElem.id = 'display-release-time';
                    releaseTimeElem.className = 'text-[9px] text-slate-500 mt-2 font-mono border-t border-white/5 pt-1 flex justify-between';
                    releaseDiv.appendChild(releaseTimeElem);
                }
                
                releaseTimeElem.innerHTML = `
                    <span>LAST RELEASE:</span>
                    <span class="text-rose-400">${sexualInfo.hours_since_release.toFixed(1)} HRS AGO</span>
                `;
            }

            document.getElementById('mood-flavor').innerText = `${data.detailed_info.mood.flavor.role} / ${data.detailed_info.mood.flavor.tone}`;
            document.getElementById('mood-desc').innerText = data.detailed_info.mood.flavor.desc;
            
            const promptContainer = document.getElementById('prompt-container');
            const promptText = document.getElementById('prompt-text');
            if (promptContainer && promptText) {
                if (data.prompt_injection) {
                    promptContainer.classList.remove('hidden');
                    promptText.innerText = data.prompt_injection;
                } else {
                    promptContainer.classList.add('hidden');
                }
            }
        }

        function updateMetric(id, value, max, prefix, suffix) {
            const percentage = Math.min(100, Math.max(0, (value / max) * 100));
            const bar = document.getElementById(`bar-${id}`);
            const text = document.getElementById(`display-${id}`);
            
            if (bar) bar.style.width = `${percentage}%`;
            if (text) text.innerText = `${prefix}${value.toFixed(1)}${suffix}`;
        }

        function updatePAD(id, value) {
            // value range: -10 to 10
            // 0 -> 50%
            // -10 -> 0%
            // 10 -> 100%
            
            // Calculate percentage position (0-100)
            const percentage = ((value + 10) / 20) * 100;
            
            const bar = document.getElementById(`bar-${id}`);
            const text = document.getElementById(`display-${id}`);
            
            if (bar) {
                // Adjust width and left position based on value relative to 0
                if (value >= 0) {
                    // Positive: start from 50%, go right
                    bar.style.left = '50%';
                    bar.style.width = `${(value / 20) * 100}%`;
                } else {
                    // Negative: start from calculated left, width goes to 50%
                    bar.style.left = `${percentage}%`;
                    bar.style.width = `${(Math.abs(value) / 20) * 100}%`;
                }
            }
            
            if (text) {
                text.innerText = value.toFixed(1);
                text.className = value > 0 ? 'text-emerald-400 font-mono' : (value < 0 ? 'text-rose-400 font-mono' : 'text-slate-400 font-mono');
            }
        }

        function setSlider(id, value) {
            const input = document.getElementById(id);
            const display = document.getElementById(`val-${id}`);
            if (input) {
                input.value = value;
                if (display) display.innerText = value;
            }
        }

        function fillCurrentValues() {
            if (!currentState) { alert('è¯·å…ˆåŠ è½½çŠ¶æ€'); return; }
            syncSlidersWithState(currentState);
        }

        async function updateState() {
            try {
                const k = getApiKey();
                const payload = {};

                payload.stamina = parseFloat(document.getElementById('stamina').value);
                payload.lust = parseFloat(document.getElementById('lust').value);
                payload.sensitivity = parseFloat(document.getElementById('sensitivity').value);
                payload.cycle_day = parseInt(document.getElementById('cycle_day').value);
                payload.sleep_state = document.getElementById('sleep_state').value;

                const p = document.getElementById('pleasure').value;
                const a = document.getElementById('arousal').value;
                const d = document.getElementById('dominance').value;
                
                if (p && a && d) {
                    payload.mood = {
                        pleasure: parseFloat(p),
                        arousal: parseFloat(a),
                        dominance: parseFloat(d)
                    };
                }

                const response = await fetch(`${API_BASE}/debug/texas-state/update?k=${k}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Failed');
                
                const btn = document.getElementById('btn-save');
                const originalText = btn.innerHTML;
                btn.innerHTML = `<span class="flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> SAVED</span>`;
                btn.classList.add('bg-emerald-600', 'border-emerald-500');
                btn.classList.remove('bg-rose-600', 'border-rose-500');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-emerald-600', 'border-emerald-500');
                    btn.classList.add('bg-rose-600', 'border-rose-500');
                }, 2000);

                await loadCurrentState();

            } catch (error) {
                alert('Update failed: ' + error.message);
            }
        }

        async function quickAction(action) {
            const k = getApiKey();
            let payload = {};
            switch(action) {
                case 'reset': payload = { stamina: 100, lust: 0, sleep_state: 'Awake', mood: { pleasure: 2.0, arousal: 0.0, dominance: 1.0 } }; break;
                case 'horny': payload = { lust: 90, sensitivity: 60, mood: { arousal: 8.0, pleasure: 5.0 } }; break;
                case 'menstrual': payload = { cycle_day: 2, stamina: 40, mood: { pleasure: -3.0, arousal: -2.0 } }; break;
                case 'tired': payload = { stamina: 15, sleep_state: 'Awake', mood: { arousal: -5.0 } }; break;
            }
            try {
                await fetch(`${API_BASE}/debug/texas-state/update?k=${k}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                await loadCurrentState();
            } catch (e) { alert(e.message); }
        }

        // Gallery & Stats Logic
        async function loadGallery(page = 0) {
            try {
                const k = getApiKey();
                currentPage = page;
                const offset = page * pageSize;
                const response = await fetch(`${API_BASE}/gallery/records?k=${k}&limit=${pageSize}&offset=${offset}`);
                const records = await response.json();
                displayGallery(records);
            } catch (error) { console.error(error); }
        }

        function displayGallery(records) {
            const list = document.getElementById('galleryList');
            if (!records || records.length === 0) {
                list.innerHTML = '<div class="col-span-full text-center py-20 text-slate-500 font-mono">NO RECORDS FOUND IN ARCHIVE</div>';
                return;
            }

            document.getElementById('gallery-count').innerText = `${records.length} ITEMS`;

            list.innerHTML = records.map(record => {
                const tags = record.tags || [];
                const displayTags = tags.slice(0, 3);
                const moreTags = tags.length - 3;
                // Format date nicely
                const d = new Date(record.recorded_at);
                const dateStr = d.toLocaleDateString(undefined, {month:'2-digit', day:'2-digit'});
                const timeStr = d.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'});

                return `
                <div class="glass-card rounded-lg overflow-hidden group flex flex-col h-[260px] relative hover:border-rose-500/30">
                    <!-- Tech header -->
                    <div class="h-1 w-full bg-gradient-to-r from-slate-700 to-slate-800 group-hover:from-rose-500 group-hover:to-rose-600 transition-all"></div>
                    
                    <div class="p-3 flex justify-between items-start border-b border-white/5 bg-slate-900/40">
                        <div class="flex flex-col">
                             <div class="flex gap-2 mb-1">
                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded-sm bg-blue-500/10 text-blue-400 border border-blue-500/20 uppercase tracking-wider">${record.body_part}</span>
                                <span class="text-[10px] font-bold px-1.5 py-0.5 rounded-sm bg-pink-500/10 text-pink-400 border border-pink-500/20 uppercase tracking-wider">${record.act_type}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] font-mono text-slate-400">${dateStr}</div>
                            <div class="text-[10px] font-mono text-slate-600">${timeStr}</div>
                        </div>
                    </div>
                    
                    <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
                        <p class="text-xs md:text-sm text-slate-300 leading-relaxed font-sans opacity-90 group-hover:opacity-100 transition">${record.summary}</p>
                    </div>

                    <div class="px-4 py-2 flex items-center gap-1.5 min-h-[30px] border-t border-white/5 bg-slate-900/20">
                        ${displayTags.map(t => `<span class="text-[9px] px-1 py-0.5 bg-slate-800 rounded-sm text-slate-400 border border-slate-700">#${t}</span>`).join('')}
                        ${moreTags > 0 ? `<span class="text-[9px] px-1 py-0.5 text-slate-600">+${moreTags}</span>` : ''}
                    </div>

                    <!-- Hidden Actions Overlay -->
                    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        <button onclick="showDetail('${record.id}')" class="px-4 py-2 bg-slate-100 text-slate-900 rounded-sm font-bold text-xs hover:bg-white tracking-wider">VIEW LOG</button>
                        <button onclick="event.stopPropagation(); deleteRecord('${record.id}')" class="px-4 py-2 border border-red-500 text-red-500 rounded-sm font-bold text-xs hover:bg-red-500 hover:text-white tracking-wider">DELETE</button>
                    </div>
                </div>
            `}).join('');
            
            // Pagination
            document.getElementById('galleryPagination').innerHTML = `
                <button onclick="loadGallery(${currentPage - 1})" ${currentPage===0?'disabled':''} class="p-2 bg-slate-800 border border-white/10 rounded disabled:opacity-50 hover:bg-slate-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span class="font-mono text-sm text-slate-400 px-4">PAGE ${currentPage + 1}</span>
                <button onclick="loadGallery(${currentPage + 1})" ${records.length<pageSize?'disabled':''} class="p-2 bg-slate-800 border border-white/10 rounded disabled:opacity-50 hover:bg-slate-700">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            `;
        }

        async function showDetail(id) {
            const k = getApiKey();
            const res = await fetch(`${API_BASE}/gallery/record/${id}?k=${k}`);
            const record = await res.json();
            
            const modal = document.getElementById('galleryModal');
            const content = document.getElementById('modalContent');
            
            content.innerHTML = `
                <div class="space-y-6">
                    <div class="flex flex-col gap-4 pb-4 border-b border-white/10">
                        <div class="flex flex-wrap items-center gap-3">
                            <span class="px-2 py-1 bg-blue-500/20 text-blue-400 font-bold border border-blue-500/30 text-xs tracking-widest uppercase">${record.body_part}</span>
                            <span class="px-2 py-1 bg-pink-500/20 text-pink-400 font-bold border border-pink-500/30 text-xs tracking-widest uppercase">${record.act_type}</span>
                            <span class="px-2 py-1 bg-yellow-500/20 text-yellow-500 font-bold border border-yellow-500/30 text-xs tracking-widest">â­ ${record.intensity}</span>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            ${(record.tags || []).map(tag => `<span class="px-2 py-0.5 bg-slate-800 text-slate-400 text-[10px] border border-slate-700 rounded-sm font-mono">#${tag}</span>`).join('')}
                        </div>
                        <div class="text-slate-500 font-mono text-[10px] select-all cursor-text break-all">
                            ID: ${record.id}<br>
                            TIME: ${new Date(record.recorded_at).toLocaleString()}
                        </div>
                    </div>

                    <div class="p-4 bg-slate-900/50 rounded border border-white/5">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Operational Summary</h4>
                        <p class="text-white text-base font-medium">${record.summary}</p>
                    </div>

                    <div class="p-4 bg-slate-900/50 rounded border border-white/5 flex-1">
                        <h4 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Complete Interaction Log</h4>
                        <p class="text-slate-300 leading-7 whitespace-pre-wrap font-sans custom-scrollbar max-h-[400px] overflow-y-auto pr-2">${record.full_story}</p>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function closeModal() { document.getElementById('galleryModal').classList.add('hidden'); }
        
        async function deleteRecord(id) {
            if(!confirm('CONFIRM DELETION? This action is irreversible.')) return;
            const k = getApiKey();
            await fetch(`${API_BASE}/gallery/record/${id}?k=${k}`, { method: 'DELETE' });
            loadGallery(currentPage);
        }

        async function loadStats() {
            const k = getApiKey();
            const res = await fetch(`${API_BASE}/gallery/stats?k=${k}`);
            const stats = await res.json();
            
            // Handle both new structure (nested) and legacy (flat) just in case
            const bodyParts = stats.body_parts || stats; 
            const actTypes = stats.act_types || {};

            const total = Object.values(bodyParts).reduce((a,b)=>a+b, 0);
            
            // --- Summary HTML ---
            const sortedBody = Object.entries(bodyParts).sort((a,b)=>b[1]-a[1]);
            
            let html = `<div class="text-5xl font-bold text-white mb-1 font-mono">${total}</div><div class="text-xs text-slate-500 uppercase tracking-widest">Total Interactions</div>`;
            
            if (total > 0) {
                html += `<div class="mt-8 space-y-4">`;
                sortedBody.slice(0, 5).forEach(([key, val]) => {
                    const pct = ((val/total)*100).toFixed(1);
                    html += `
                        <div>
                            <div class="flex justify-between text-xs mb-1 font-mono">
                                <span class="text-slate-300 uppercase">${key}</span>
                                <span class="text-slate-500">${val} <span class="text-slate-600">/</span> ${pct}%</span>
                            </div>
                            <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-rose-500" style="width: ${pct}%"></div>
                            </div>
                        </div>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<div class="mt-8 text-xs text-slate-500 font-mono">NO DATA AVAILABLE</div>`;
            }
            document.getElementById('statsContent').innerHTML = html;

            // --- Chart 1: Body Parts ---
            const ctx = document.getElementById('bodyPartChart').getContext('2d');
            if (window.myChart) window.myChart.destroy();
            
            const bodyLabels = Object.keys(bodyParts);
            const bodyData = Object.values(bodyParts);

            window.myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: bodyLabels.length ? bodyLabels : ['No Data'],
                    datasets: [{
                        data: bodyData.length ? bodyData : [1], // Placeholder if empty
                        backgroundColor: bodyData.length ? ['#e11d48', '#f59e0b', '#8b5cf6', '#10b981', '#3b82f6'] : ['#1e293b'],
                        borderColor: '#0f172a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'monospace' }, boxWidth: 10 } },
                        tooltip: { enabled: bodyData.length > 0 }
                    }
                }
            });

            // --- Chart 2: Act Types ---
            const ctx2 = document.getElementById('actTypeChart').getContext('2d');
            if (window.actChart) window.actChart.destroy();
            
            const actLabels = Object.keys(actTypes);
            const actData = Object.values(actTypes);
            
            window.actChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: actLabels.length ? actLabels : ['No Data'],
                    datasets: [{
                        data: actData.length ? actData : [1],
                        backgroundColor: actData.length ? ['#3b82f6', '#ec4899', '#6366f1', '#14b8a6', '#f97316'] : ['#1e293b'],
                        borderColor: '#0f172a',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'monospace' }, boxWidth: 10 } },
                        tooltip: { enabled: actData.length > 0 }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
             initInteractions();
             loadCurrentState();
        });
    </script>
</body>
</html>
