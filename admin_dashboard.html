<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas AI ç®¡ç†é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .stat-item {
            transition: transform 0.2s;
        }
        .stat-item:hover {
            transform: translateY(-2px);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .gallery-item {
            transition: all 0.3s;
            cursor: pointer;
        }
        .gallery-item:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        .mood-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-button {
            transition: all 0.3s;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="card p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">ğŸŒŸ Texas AI ç®¡ç†é¢æ¿</h1>
                    <p class="text-gray-600 mt-2">å®æ—¶çŠ¶æ€ç›‘æ§ä¸CGé™ˆåˆ—é¦†</p>
                </div>
                <div class="flex flex-col items-end">
                    <label class="text-sm text-gray-600 mb-2">APIå¯†é’¥</label>
                    <input
                        type="password"
                        id="apiKey"
                        placeholder="è¾“å…¥å¯†é’¥ (k)"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                    >
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="card p-2 mb-6">
            <div class="flex gap-2">
                <button onclick="switchTab('status')" class="tab-button active flex-1 px-6 py-3 rounded-lg font-semibold" id="tab-status">
                    ğŸ“Š çŠ¶æ€ç®¡ç†
                </button>
                <button onclick="switchTab('gallery')" class="tab-button flex-1 px-6 py-3 rounded-lg font-semibold" id="tab-gallery">
                    ğŸ¨ CGé™ˆåˆ—é¦†
                </button>
                <button onclick="switchTab('stats')" class="tab-button flex-1 px-6 py-3 rounded-lg font-semibold" id="tab-stats">
                    ğŸ“ˆ ç»Ÿè®¡åˆ†æ
                </button>
            </div>
        </div>

        <!-- Status Management Tab -->
        <div id="content-status" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Current State Display -->
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold text-gray-800">ğŸ’« å½“å‰çŠ¶æ€</h2>
                        <button onclick="loadCurrentState()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                            ğŸ”„ åˆ·æ–°
                        </button>
                    </div>
                    <div id="currentState" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">ç‚¹å‡»åˆ·æ–°åŠ è½½çŠ¶æ€</div>
                    </div>
                </div>

                <!-- State Modification Form -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ ä¿®æ”¹çŠ¶æ€</h2>
                    <form id="updateForm" class="space-y-4">
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-700 border-b pb-2">ğŸ¥ ç”Ÿç†çŠ¶æ€</h3>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ä½“åŠ› (Stamina)</label>
                                <input type="number" id="stamina" min="0" max="100" step="0.1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0 (è™šå¼±)</span>
                                    <span>100 (å……æ²›)</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¬²æœ› (Lust)</label>
                                <input type="number" id="lust" min="0" max="100" step="0.1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0 (å¹³é™)</span>
                                    <span>100 (ç†æ™ºå´©å)</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ•æ„Ÿåº¦ (Sensitivity)</label>
                                <input type="number" id="sensitivity" min="0" max="100" step="0.1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>0 (çº¯çœŸ)</span>
                                    <span>100 (å¼€å‘å®Œæˆ)</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç”Ÿç†å‘¨æœŸæ—¥ (Cycle Day)</label>
                                <input type="number" id="cycle_day" min="1" max="28" step="1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>1-5: ç»æœŸ</span>
                                    <span>12-16: æ’åµæœŸ</span>
                                    <span>24-28: PMS</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ç¡çœ çŠ¶æ€ (Sleep State)</label>
                                <select id="sleep_state" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="Awake">æ¸…é†’ (Awake)</option>
                                    <option value="DeepSleep">æ·±åº¦ç¡çœ  (DeepSleep)</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-700 border-b pb-2">ğŸ’­ æƒ…ç»ªçŠ¶æ€ (PADæ¨¡å‹)</h3>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ„‰æ‚¦åº¦ (Pleasure)</label>
                                <input type="number" id="pleasure" min="-10" max="10" step="0.1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>-10 (ç—›è‹¦)</span>
                                    <span>0 (ä¸­ç«‹)</span>
                                    <span>10 (å¿«ä¹)</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ¿€æ´»åº¦ (Arousal)</label>
                                <input type="number" id="arousal" min="-10" max="10" step="0.1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>-10 (å¹³é™)</span>
                                    <span>0 (ä¸­ç«‹)</span>
                                    <span>10 (å…´å¥‹)</span>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æŒæ§åº¦ (Dominance)</label>
                                <input type="number" id="dominance" min="-10" max="10" step="0.1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>-10 (é¡ºä»)</span>
                                    <span>0 (ä¸­ç«‹)</span>
                                    <span>10 (æŒæ§)</span>
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 flex gap-3">
                            <button type="button" onclick="updateState()" class="flex-1 btn-primary text-white px-6 py-3 rounded-lg font-semibold">
                                ğŸ’¾ ä¿å­˜ä¿®æ”¹
                            </button>
                            <button type="button" onclick="fillCurrentValues()" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300">
                                ğŸ“‹ å¡«å……å½“å‰å€¼
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card p-6 mt-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">âš¡ å¿«é€Ÿæ“ä½œ</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="quickAction('reset')" class="p-4 bg-green-100 hover:bg-green-200 rounded-lg transition">
                        <div class="text-2xl mb-2">ğŸ”„</div>
                        <div class="text-sm font-semibold">å®Œå…¨æ¢å¤</div>
                    </button>
                    <button onclick="quickAction('horny')" class="p-4 bg-red-100 hover:bg-red-200 rounded-lg transition">
                        <div class="text-2xl mb-2">ğŸ”¥</div>
                        <div class="text-sm font-semibold">å‘æƒ…çŠ¶æ€</div>
                    </button>
                    <button onclick="quickAction('menstrual')" class="p-4 bg-pink-100 hover:bg-pink-200 rounded-lg transition">
                        <div class="text-2xl mb-2">ğŸ©¸</div>
                        <div class="text-sm font-semibold">ç»æœŸçŠ¶æ€</div>
                    </button>
                    <button onclick="quickAction('tired')" class="p-4 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                        <div class="text-2xl mb-2">ğŸ˜´</div>
                        <div class="text-sm font-semibold">ç–²æƒ«çŠ¶æ€</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Gallery Tab -->
        <div id="content-gallery" class="tab-content hidden">
            <div class="card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ¨ CGé™ˆåˆ—é¦†</h2>
                    <button onclick="loadGallery()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ğŸ”„ åˆ·æ–°åˆ—è¡¨
                    </button>
                </div>
                <div id="galleryList" class="space-y-4">
                    <div class="text-center py-8 text-gray-400">ç‚¹å‡»åˆ·æ–°åŠ è½½CGè®°å½•</div>
                </div>
                <div id="galleryPagination" class="mt-6 flex justify-center gap-2"></div>
            </div>
        </div>

        <!-- Stats Tab -->
        <div id="content-stats" class="tab-content hidden">
            <div class="card p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“ˆ ç»Ÿè®¡åˆ†æ</h2>
                    <button onclick="loadStats()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                        ğŸ”„ åˆ·æ–°ç»Ÿè®¡
                    </button>
                </div>
                <div id="statsContent">
                    <div class="text-center py-8 text-gray-400">ç‚¹å‡»åˆ·æ–°åŠ è½½ç»Ÿè®¡ä¿¡æ¯</div>
                </div>
            </div>
        </div>

        <!-- Modal for Gallery Detail -->
        <div id="galleryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="closeModal()">
            <div class="card p-6 max-w-3xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-bold text-gray-800">ğŸ“– è®°å½•è¯¦æƒ…</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸå
        const API_BASE = window.location.origin;
        let currentState = null;
        let currentPage = 0;
        const pageSize = 10;

        function getApiKey() {
            const key = document.getElementById('apiKey').value;
            if (!key) {
                alert('è¯·å…ˆè¾“å…¥APIå¯†é’¥ï¼');
                throw new Error('Missing API key');
            }
            return key;
        }

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${tab}`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`content-${tab}`).classList.remove('hidden');

            // Load data for the tab
            if (tab === 'gallery') {
                loadGallery();
            } else if (tab === 'stats') {
                loadStats();
            }
        }

        async function loadCurrentState() {
            try {
                const k = getApiKey();
                const response = await fetch(`${API_BASE}/debug/texas-state?k=${k}`);
                if (!response.ok) throw new Error('Failed to load state');

                const data = await response.json();
                currentState = data;
                displayCurrentState(data);
            } catch (error) {
                console.error('Error loading state:', error);
                alert('åŠ è½½çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        function displayCurrentState(data) {
            const bio = data.bio;
            const mood = data.mood;

            const html = `
                <div class="space-y-6">
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3 border-b pb-2">ğŸ¥ ç”Ÿç†çŠ¶æ€</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">ä½“åŠ›</span>
                                <span class="font-semibold">${bio.stamina.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">æ¬²æœ›</span>
                                <span class="font-semibold text-red-600">${bio.lust.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">æ•æ„Ÿåº¦</span>
                                <span class="font-semibold text-purple-600">${bio.sensitivity.toFixed(1)}%</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">ç”Ÿç†å‘¨æœŸ</span>
                                <span class="font-semibold">ç¬¬ ${bio.cycle_day} å¤©</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">ç¡çœ çŠ¶æ€</span>
                                <span class="font-semibold">${bio.sleep_state}</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-700 mb-3 border-b pb-2">ğŸ’­ æƒ…ç»ªçŠ¶æ€</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">æ„‰æ‚¦åº¦ (P)</span>
                                <span class="font-semibold ${mood.pleasure > 0 ? 'text-green-600' : 'text-red-600'}">${mood.pleasure.toFixed(1)}</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">æ¿€æ´»åº¦ (A)</span>
                                <span class="font-semibold ${mood.arousal > 0 ? 'text-orange-600' : 'text-blue-600'}">${mood.arousal.toFixed(1)}</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                                <span class="text-gray-600">æŒæ§åº¦ (D)</span>
                                <span class="font-semibold ${mood.dominance > 0 ? 'text-purple-600' : 'text-gray-600'}">${mood.dominance.toFixed(1)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-gray-700 mb-2">ğŸ“ ç³»ç»Ÿæç¤ºè¯æ³¨å…¥</h3>
                        <pre class="text-xs text-gray-600 whitespace-pre-wrap overflow-x-auto">${data.prompt_injection}</pre>
                    </div>
                </div>
            `;

            document.getElementById('currentState').innerHTML = html;
        }

        function fillCurrentValues() {
            if (!currentState) {
                alert('è¯·å…ˆåˆ·æ–°å½“å‰çŠ¶æ€ï¼');
                return;
            }

            const bio = currentState.bio;
            const mood = currentState.mood;

            document.getElementById('stamina').value = bio.stamina;
            document.getElementById('lust').value = bio.lust;
            document.getElementById('sensitivity').value = bio.sensitivity;
            document.getElementById('cycle_day').value = bio.cycle_day;
            document.getElementById('sleep_state').value = bio.sleep_state;
            document.getElementById('pleasure').value = mood.pleasure;
            document.getElementById('arousal').value = mood.arousal;
            document.getElementById('dominance').value = mood.dominance;
        }

        async function updateState() {
            try {
                const k = getApiKey();
                const payload = {};

                // Collect bio state
                const stamina = document.getElementById('stamina').value;
                const lust = document.getElementById('lust').value;
                const sensitivity = document.getElementById('sensitivity').value;
                const cycle_day = document.getElementById('cycle_day').value;
                const sleep_state = document.getElementById('sleep_state').value;

                if (stamina) payload.stamina = parseFloat(stamina);
                if (lust) payload.lust = parseFloat(lust);
                if (sensitivity) payload.sensitivity = parseFloat(sensitivity);
                if (cycle_day) payload.cycle_day = parseInt(cycle_day);
                if (sleep_state) payload.sleep_state = sleep_state;

                // Collect mood state
                const pleasure = document.getElementById('pleasure').value;
                const arousal = document.getElementById('arousal').value;
                const dominance = document.getElementById('dominance').value;

                if (pleasure || arousal || dominance) {
                    payload.mood = {};
                    if (pleasure) payload.mood.pleasure = parseFloat(pleasure);
                    if (arousal) payload.mood.arousal = parseFloat(arousal);
                    if (dominance) payload.mood.dominance = parseFloat(dominance);
                }

                if (Object.keys(payload).length === 0) {
                    alert('è¯·è‡³å°‘å¡«å†™ä¸€ä¸ªè¦ä¿®æ”¹çš„æ•°å€¼ï¼');
                    return;
                }

                const response = await fetch(`${API_BASE}/debug/texas-state/update?k=${k}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Failed to update state');

                const result = await response.json();
                alert('âœ… çŠ¶æ€æ›´æ–°æˆåŠŸï¼');

                // Clear form and reload state
                document.getElementById('updateForm').reset();
                await loadCurrentState();
            } catch (error) {
                console.error('Error updating state:', error);
                alert('æ›´æ–°çŠ¶æ€å¤±è´¥: ' + error.message);
            }
        }

        async function quickAction(action) {
            const k = getApiKey();
            let payload = {};

            switch(action) {
                case 'reset':
                    payload = {
                        stamina: 100,
                        lust: 0,
                        sleep_state: 'Awake',
                        mood: { pleasure: 2.0, arousal: 0.0, dominance: 1.0 }
                    };
                    break;
                case 'horny':
                    payload = {
                        lust: 90,
                        sensitivity: 60,
                        mood: { arousal: 8.0, pleasure: 5.0 }
                    };
                    break;
                case 'menstrual':
                    payload = {
                        cycle_day: 2,
                        stamina: 40,
                        mood: { pleasure: -3.0, arousal: -2.0 }
                    };
                    break;
                case 'tired':
                    payload = {
                        stamina: 15,
                        sleep_state: 'Awake',
                        mood: { arousal: -5.0 }
                    };
                    break;
            }

            try {
                const response = await fetch(`${API_BASE}/debug/texas-state/update?k=${k}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Failed to update state');

                alert('âœ… å¿«é€Ÿæ“ä½œæˆåŠŸï¼');
                await loadCurrentState();
            } catch (error) {
                console.error('Error in quick action:', error);
                alert('æ“ä½œå¤±è´¥: ' + error.message);
            }
        }

        async function loadGallery(page = 0) {
            try {
                const k = getApiKey();
                currentPage = page;
                const offset = page * pageSize;

                const response = await fetch(`${API_BASE}/gallery/records?k=${k}&limit=${pageSize}&offset=${offset}`);
                if (!response.ok) throw new Error('Failed to load gallery');

                const records = await response.json();
                displayGallery(records);
            } catch (error) {
                console.error('Error loading gallery:', error);
                alert('åŠ è½½é™ˆåˆ—é¦†å¤±è´¥: ' + error.message);
            }
        }

        function displayGallery(records) {
            if (!records || records.length === 0) {
                document.getElementById('galleryList').innerHTML = '<div class="text-center py-8 text-gray-400">æš‚æ— è®°å½•</div>';
                return;
            }

            const html = records.map(record => `
                <div class="gallery-item p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg" onclick="showDetail('${record.id}')">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 bg-purple-500 text-white text-xs font-semibold rounded-full">${record.body_part}</span>
                                <span class="px-3 py-1 bg-pink-500 text-white text-xs font-semibold rounded-full">${record.act_type}</span>
                                <span class="text-xs text-gray-500">å¼ºåº¦: ${'â­'.repeat(record.intensity)}</span>
                            </div>
                            <p class="text-gray-700 text-sm mb-2">${record.summary}</p>
                            <div class="flex flex-wrap gap-1">
                                ${(record.tags || []).map(tag => `<span class="px-2 py-0.5 bg-white text-gray-600 text-xs rounded">#${tag}</span>`).join('')}
                            </div>
                        </div>
                        <div class="text-right text-xs text-gray-500 ml-4">
                            <div>${new Date(record.recorded_at).toLocaleDateString('zh-CN')}</div>
                            <div>${new Date(record.recorded_at).toLocaleTimeString('zh-CN')}</div>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('galleryList').innerHTML = html;

            // Pagination
            const paginationHtml = `
                <button onclick="loadGallery(${currentPage - 1})" ${currentPage === 0 ? 'disabled' : ''}
                        class="px-4 py-2 bg-purple-500 text-white rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed">
                    ä¸Šä¸€é¡µ
                </button>
                <span class="px-4 py-2">ç¬¬ ${currentPage + 1} é¡µ</span>
                <button onclick="loadGallery(${currentPage + 1})" ${records.length < pageSize ? 'disabled' : ''}
                        class="px-4 py-2 bg-purple-500 text-white rounded-lg disabled:bg-gray-300 disabled:cursor-not-allowed">
                    ä¸‹ä¸€é¡µ
                </button>
            `;
            document.getElementById('galleryPagination').innerHTML = paginationHtml;
        }

        async function showDetail(recordId) {
            try {
                const k = getApiKey();
                const response = await fetch(`${API_BASE}/gallery/record/${recordId}?k=${k}`);
                if (!response.ok) throw new Error('Failed to load record detail');

                const record = await response.json();

                const html = `
                    <div class="space-y-4">
                        <div class="flex gap-2">
                            <span class="px-3 py-1 bg-purple-500 text-white text-sm font-semibold rounded-full">${record.body_part}</span>
                            <span class="px-3 py-1 bg-pink-500 text-white text-sm font-semibold rounded-full">${record.act_type}</span>
                            <span class="px-3 py-1 bg-yellow-500 text-white text-sm font-semibold rounded-full">å¼ºåº¦: ${record.intensity}</span>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">ğŸ“ æ‘˜è¦</h4>
                            <p class="text-gray-600 bg-gray-50 p-3 rounded">${record.summary}</p>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">ğŸ“– å®Œæ•´æ•…äº‹</h4>
                            <p class="text-gray-600 bg-gray-50 p-3 rounded whitespace-pre-wrap">${record.full_story}</p>
                        </div>

                        <div>
                            <h4 class="font-semibold text-gray-700 mb-2">ğŸ·ï¸ æ ‡ç­¾</h4>
                            <div class="flex flex-wrap gap-2">
                                ${(record.tags || []).map(tag => `<span class="px-3 py-1 bg-purple-100 text-purple-700 text-sm rounded">#${tag}</span>`).join('')}
                            </div>
                        </div>

                        <div class="text-xs text-gray-500 pt-3 border-t">
                            <p>è®°å½•æ—¶é—´: ${new Date(record.recorded_at).toLocaleString('zh-CN')}</p>
                            <p>è®°å½•ID: ${record.id}</p>
                        </div>
                    </div>
                `;

                document.getElementById('modalContent').innerHTML = html;
                document.getElementById('galleryModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading detail:', error);
                alert('åŠ è½½è¯¦æƒ…å¤±è´¥: ' + error.message);
            }
        }

        function closeModal() {
            document.getElementById('galleryModal').classList.add('hidden');
        }

        async function loadStats() {
            try {
                const k = getApiKey();
                const response = await fetch(`${API_BASE}/gallery/stats?k=${k}`);
                if (!response.ok) throw new Error('Failed to load stats');

                const stats = await response.json();
                displayStats(stats);
            } catch (error) {
                console.error('Error loading stats:', error);
                alert('åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + error.message);
            }
        }

        function displayStats(stats) {
            if (!stats || Object.keys(stats).length === 0) {
                document.getElementById('statsContent').innerHTML = '<div class="text-center py-8 text-gray-400">æš‚æ— ç»Ÿè®¡æ•°æ®</div>';
                return;
            }

            const sortedStats = Object.entries(stats).sort((a, b) => b[1] - a[1]);
            const total = sortedStats.reduce((sum, [_, count]) => sum + count, 0);

            const html = `
                <div class="space-y-6">
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-6 rounded-lg">
                        <div class="text-center">
                            <div class="text-4xl font-bold text-purple-600">${total}</div>
                            <div class="text-gray-600 mt-2">æ€»è®°å½•æ•°</div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold text-gray-700 mb-4 text-lg">ğŸ“Š éƒ¨ä½ç»Ÿè®¡</h3>
                        <div class="space-y-3">
                            ${sortedStats.map(([part, count]) => {
                                const percentage = ((count / total) * 100).toFixed(1);
                                return `
                                    <div class="stat-item">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium text-gray-700">${part}</span>
                                            <span class="text-sm text-gray-600">${count} æ¬¡ (${percentage}%)</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full transition-all duration-500"
                                                 style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('statsContent').innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load API key from localStorage
            const savedKey = localStorage.getItem('apiKey');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }

            // Save API key to localStorage on change
            document.getElementById('apiKey').addEventListener('change', (e) => {
                localStorage.setItem('apiKey', e.target.value);
            });
        });
    </script>
</body>
</html>
